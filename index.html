<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <style>
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html, body { height: 100%; overflow: hidden; }
        body { background: linear-gradient(to right, #6a11cb, #2575fc); display: flex; color: #fff; }

         /* --- Wrapper --- */
         .admin-view-wrapper { width: 100%; height: 100%; display: flex; background-color: rgba(0,0,0,0.1); }

        /* --- Sidebar --- */
        .sidebar { width: 280px; background: rgba(255, 255, 255, 0.08); border-right: 1px solid rgba(255, 255, 255, 0.2); display: flex; flex-direction: column; flex-shrink: 0; color: #eee; height: 100%; overflow: hidden; }
        .sidebar .content-wrapper { padding: 15px; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .admin-header { border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 15px; margin-bottom: 15px; flex-shrink: 0; }
        .admin-header h3 { margin-bottom: 10px; font-size: 1.3em; color: #fff; }
        #admin-profile { font-size: 0.85em; margin-bottom: 5px; word-break: break-all; } #admin-profile strong { color: #fff; }
        #user-count { font-size: 0.85em; margin-bottom: 10px; color: #ccc;}
        .sidebar-actions button { width: 100%; margin-bottom: 8px; font-size: 0.9em; padding: 8px 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; border: 1px solid rgba(255,255,255,0.3); }
        #logoutButton { background-color: #ff4f81; color: white;} #logoutButton:hover { background-color: #e03060; }
        #muteButton { background-color: #ffd700; color: #333; } #muteButton:hover { background-color: #e0a800;} #muteButton.muted { background-color: #ff8c00; color: white; }
        .user-list-header { padding-bottom: 5px; font-weight: bold; border-bottom: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 5px; font-size: 0.9em; flex-shrink: 0; }
        .user-list-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
        .user-list-container::-webkit-scrollbar { width: 6px; } .user-list-container::-webkit-scrollbar-track { background: transparent; } .user-list-container::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.3); border-radius: 3px; }
        #user-list { list-style: none; padding: 0; margin: 0; }
        #user-list li { padding: 10px 0px 10px 5px; cursor: pointer; border-bottom: 1px solid rgba(255, 255, 255, 0.1); transition: background-color 0.2s ease; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        #user-list li:hover { background-color: rgba(255, 255, 255, 0.1); }
        #user-list li.active { background-color: #2575fc; color: white; font-weight: 500; } #user-list li.active:hover { background-color: #1a5fce; }
        #user-list li .user-name { overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 10px; white-space: nowrap;}
        #user-list li .unread-indicator { min-width: 18px; height: 18px; background-color: #ff4f81; border-radius: 50%; color: white; font-size: 0.7em; font-weight: bold; text-align: center; line-height: 18px; padding: 0 4px; flex-shrink: 0; opacity: 0; transform: scale(0.5); transition: opacity 0.3s ease, transform 0.3s ease; }
        #user-list li .unread-indicator.visible { opacity: 1; transform: scale(1); }

        /* --- Chat Container --- */
        .chat-container { flex: 1; height: 100%; background-color: transparent; display: flex; flex-direction: column; position: relative; overflow: hidden; padding: 0; }

        /* Chat Header */
        .chat-header { padding: 12px 20px; /* Slightly less padding */ background-color: rgba(0, 0, 0, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.2); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .chat-header-left h2 { margin: 0; font-size: 1.15em; /* Slightly smaller */ color: #fff; }
        #user-status { font-size: 0.8em; color: #ddd; margin-top: 2px; }
        #user-status .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; display: inline-block; vertical-align: middle; background-color: #aaa; transition: background-color 0.3s ease; box-shadow: 0 0 2px rgba(0,0,0,0.4); }
        #user-status .status-dot.online { background-color: #33ff33; } #user-status .status-dot.offline { background-color: #aaa; }

        /* --- Adjusted Action Button Styles --- */
        .chat-actions { display: flex; align-items: center; } /* Ensure alignment */
        .chat-actions button {
             margin-left: 5px; /* Tighter spacing */
             padding: 4px 8px; /* Smaller padding */
             font-size: 0.75em; /* Smaller font */
             background-color: rgba(255,255,255, 0.2); color: #fff; border: 1px solid rgba(255,255,255,0.3); cursor: pointer; border-radius: 4px; transition: background-color 0.2s ease; line-height: 1.4; /* Adjust line height */
         }
        .chat-actions button:hover:not(:disabled) { background-color: rgba(255,255,255, 0.35); }
        .chat-actions button:disabled { background-color: rgba(255,255,255, 0.1); color: #aaa; cursor: not-allowed; }
        #blockUserButton { background-color: #ffd700; color: #333;} #blockUserButton.unblock { background-color: #33ff33; color: #000;}
        #deleteUserButton { background-color: #ff4f81; color: white; }
        #exportChatButton { background-color: #00c6ff; color: #000; }
        /* Style for the new Start Call button */
        #startCallButton { background-color: #28a745; color: white; } /* Green for call */
        #startCallButton:hover:not(:disabled) { background-color: #218838; }

        /* Messages Area */
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
        .messages::-webkit-scrollbar { width: 6px; } .messages::-webkit-scrollbar-track { background: transparent; } .messages::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.4); border-radius: 3px; }

        /* Message Styles */
        .message-wrapper { display: flex; margin-bottom: 12px; max-width: 85%; animation: fadeIn 0.3s ease-out; opacity: 0; animation-fill-mode: forwards; }
        .message-wrapper.sent { align-self: flex-end; } .message-wrapper.received { align-self: flex-start; } .message-wrapper.bot { align-self: flex-start; }
        .message-wrapper p { padding: 10px 15px; border-radius: 15px; word-wrap: break-word; line-height: 1.4; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        .message-wrapper.sent p { background-color: #00c6ff; border-bottom-right-radius: 5px; }
        .message-wrapper.received p { background-color: #ffd700; border-bottom-left-radius: 5px; }
        .message-wrapper.bot p { background-color: rgba(255, 255, 255, 0.8); color: #333; border-bottom-left-radius: 5px; }
        .message-wrapper .timestamp { font-size: 0.7em; color: rgba(255, 255, 255, 0.65); margin-top: 4px; display: block; }
        .message-wrapper.sent .timestamp { text-align: right; padding-right: 5px; }
        .message-wrapper.received .timestamp, .message-wrapper.bot .timestamp { text-align: left; padding-left: 5px; }
        .message-wrapper.bot .timestamp { display: none; }
        .message-wrapper.received .timestamp::after { content: ''; display: inline-block; width: 14px; height: 14px; margin-left: 5px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 15.1"><path fill="%23aaccaa" d="M15.6 3.4l-1.1-1.1-8.9 8.9L1.8 7.4l-1.1 1.1 4.8 4.8 10.1-10z"/></svg>'); background-repeat: no-repeat; background-size: contain; vertical-align: text-bottom; opacity: 0.7; }
        .message-wrapper.received.seen .timestamp::after { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 15.1"><path fill="%2333ff33" d="M17.6 3.4L16.5 2.3C13.1-1.1 7.1 2.1 4.7 4.5l-1.9 1.9-1.1 1.1 4.8 4.8 1.1-1.1 1.9-1.9c2.4-2.4 8.4-5.6 10.1-3.9zm-4.8 4.8l-1.1 1.1-4.8-4.8L8 3.4l1.1-1.1 4.8 4.8z"/></svg>'); opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Typing Indicator */
        #typing-indicator { min-height: 18px; font-style: italic; color: rgba(255, 255, 255, 0.75); font-size: 0.85em; padding: 5px 20px; flex-shrink: 0; }

        /* Input Area */
        .input-area { display: flex; gap: 10px; padding: 15px 20px; background-color: rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.2); flex-shrink: 0; }
        .input-area input[type="text"], .input-area input[type="password"] { flex: 1; padding: 12px 15px; border: none; border-radius: 10px; background-color: rgba(255, 255, 255, 0.9); color: #333; outline: none; font-size: 0.95em; }
        .input-area input::placeholder { color: #777; } .input-area input:disabled { background-color: #ddd; cursor: not-allowed; }
        .input-area button { padding: 12px 18px; border-radius: 10px; background-color: #00ffcc; color: #000; font-weight: bold; transition: background-color 0.2s ease; border: none; cursor: pointer; font-size: 0.95em; }
        .input-area button:hover:not(:disabled) { background-color: #00ccaa; } .input-area button:disabled { background-color: #aaa; cursor: not-allowed; opacity: 0.7; }

        /* Call Notifications Overlay */
        #call-notifications-container { position: absolute; top: 65px; /* Adjusted */ right: 15px; z-index: 100; display: flex; flex-direction: column; gap: 10px; max-width: 280px; }
        .call-alert { padding: 10px 12px; /* Smaller */ border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 3px 10px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 0.85em; /* Smaller */ backdrop-filter: blur(5px); }
        .call-alert.incoming { background-color: rgba(40, 167, 69, 0.85); } .call-alert.active { background-color: rgba(0, 123, 255, 0.85); } .call-alert.calling { background-color: rgba(255, 193, 7, 0.85); color: #000;} /* Yellowish for outgoing */
        .call-alert span strong { font-weight: bold; }
        .call-alert .button-group { display: flex; gap: 6px; }
        .call-alert button { margin-left: 4px; background-color: rgba(255,255,255,0.85); color: #333; padding: 4px 8px; /* Smaller */ font-size: 0.8em; /* Smaller */ border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s ease; }
        .call-alert button:hover { background-color: rgba(255,255,255, 1); }
        .call-alert button.join { background-color: #33ff33; color: #000;} .call-alert button.join:hover { background-color: #00e600; }
        .call-alert button.reject, .call-alert button.end, .call-alert button.cancel { background-color: #ff4f81; color: white; } /* Added cancel style */
        .call-alert button.reject:hover, .call-alert button.end:hover, .call-alert button.cancel:hover { background-color: #e03060; }

        /* Utility */
        .hidden { display: none !important; }
        /* Hidden Audio Elements */
        .hidden-audio { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        /* Mobile Adjustments */
         @media (max-width: 768px) {
             html, body { height: auto; overflow: auto; }
             .admin-view-wrapper { flex-direction: column; height: auto; min-height: 100vh; }
             .sidebar { width: 100% !important; height: auto; max-height: 45vh; border-right: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); order: 1; overflow: hidden; }
             .sidebar .content-wrapper { padding: 10px 15px; }
             .user-list-container { overflow-y: auto; flex-grow: 1; }
             .chat-container { order: 2; flex: 1; min-height: 55vh; height: auto; }
             .chat-header { padding: 10px 15px; /* Further reduced padding */ }
             .chat-header-left h2 { font-size: 1.05em;} /* Smaller title on mobile */
             .chat-actions { flex-wrap: wrap; gap: 4px; justify-content: flex-end;} /* Allow wrapping */
             .chat-actions button { font-size: 0.7em; padding: 3px 6px; margin-left: 3px;} /* Even smaller */
             .messages { padding: 15px; flex-grow: 1; }
             .input-area { padding: 10px 15px; } .input-area input, .input-area button { font-size: 0.9em; }
             #call-notifications-container { top: 50px; /* Adjusted */ right: 10px; max-width: 180px;} /* Smaller alerts */
             .call-alert { padding: 8px 10px; font-size: 0.8em; }
             .call-alert button { padding: 3px 6px; font-size: 0.75em;}
         }
    </style>
</head>
<body>

    <!-- Main container -->
    <div class="admin-view-wrapper">

        <!-- Sidebar -->
        <aside class="sidebar" id="admin-sidebar">
            <div class="content-wrapper">
                <div class="admin-header">
                    <h3>Admin Panel</h3>
                    <div id="admin-profile">Logged in as: <strong id="admin-email-display"></strong></div>
                    <div id="user-count">Total Users: <strong id="user-count-display">0</strong></div>
                    <div class="sidebar-actions">
                        <button id="muteButton">Mute Alerts</button>
                        <button id="logoutButton">Logout</button>
                    </div>
                </div>
                <div class="user-list-header">Users</div>
                <div class="user-list-container">
                    <ul id="user-list"></ul>
                </div>
            </div>
        </aside>

        <!-- Chat Container -->
        <div class="chat-container" id="main-chat-area">
            <!-- Header -->
            <div class="chat-header" id="main-chat-header">
                <div class="chat-header-left">
                     <h2 id="current-chat-userName">Admin Login / Select User</h2>
                     <div id="user-status" class="hidden">User: <span class="status-dot offline" title="Offline"></span></div>
                </div>
                <!-- Admin actions -->
                <div class="chat-header-right chat-actions hidden" id="main-chat-actions">
                     <button id="startCallButton" disabled>Call</button> <!-- Added Call Button -->
                     <button id="blockUserButton" disabled>Block</button>
                     <button id="deleteUserButton" disabled>Delete User</button>
                     <button id="exportChatButton" disabled>Export</button>
                </div>
            </div>

             <!-- Typing Indicator -->
             <div id="typing-indicator"></div>

             <!-- Messages -->
            <div class="messages" id="messages"></div>

            <!-- Input Area -->
            <div class="input-area" id="main-input-area">
                <input type="text" id="messageInput" placeholder="Enter credentials or select user..." autocomplete="off">
                <button id="sendButton">Send</button>
            </div>
        </div>
    </div>

     <!-- Call Notifications (Overlay) -->
     <div id="call-notifications-container"></div>

    <!-- Audio elements -->
    <audio id="ringtone" src="ringtone.mp3" preload="auto"></audio>
    <audio id="localAudio" autoplay muted class="hidden-audio"></audio>
    <audio id="remoteAudio" autoplay class="hidden-audio"></audio>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, onChildAdded, onChildChanged, serverTimestamp, query, orderByChild, limitToLast, update, remove, off, get, child } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = { /* ... SAME ... */
             apiKey: "AIzaSyA5mBW5mXff46acu01BbPmZh8LGGXV42v8", authDomain: "chat-app-ddecb.firebaseapp.com", databaseURL: "https://chat-app-ddecb-default-rtdb.firebaseio.com", projectId: "chat-app-ddecb", storageBucket: "chat-app-ddecb.firebasestorage.app", messagingSenderId: "534760202357", appId: "1:534760202357:web:da7d90561af1c4220a183c", measurementId: "G-MCSSLKG71W"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- DOM Elements ---
        // ... (Includes NEW #startCallButton) ...
        const startCallButton = document.getElementById('startCallButton'); // Added
        const adminSidebar = document.getElementById('admin-sidebar');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const adminEmailDisplay = document.getElementById('admin-email-display');
        const userCountDisplay = document.getElementById('user-count-display');
        const logoutButton = document.getElementById('logoutButton');
        const userListUL = document.getElementById('user-list');
        const mainChatHeader = document.getElementById('main-chat-header');
        const currentChatUserNameH2 = document.getElementById('current-chat-userName');
        const userStatusDiv = document.getElementById('user-status');
        const userStatusSpan = userStatusDiv.querySelector('.status-dot');
        const mainChatActions = document.getElementById('main-chat-actions');
        const typingIndicatorDiv = document.getElementById('typing-indicator');
        const blockUserButton = document.getElementById('blockUserButton');
        const deleteUserButton = document.getElementById('deleteUserButton'); // Updated ID
        const exportChatButton = document.getElementById('exportChatButton');
        const callNotificationsContainer = document.getElementById('call-notifications-container');
        const ringtoneAudio = document.getElementById('ringtone');
        const muteButton = document.getElementById('muteButton');
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');


        // --- State Variables ---
        // ... (No major changes needed here) ...
        let appState = 'LOGIN_BOT_INIT'; let tempEmail = ''; let tempPassword = ''; let selectedUserId = null;
        let currentUserList = {}; let typingTimeout = null; let isMuted = localStorage.getItem('adminMuted') === 'true';
        let globalListeners = { users: null, calls: null }; let currentAdminUser = null; let botMessageTimeout;
        let peerConnection = null; let localStream = null; let activeCallUserId = null;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let callSignalListeners = {};
        let userToSelectOnLoad = null;


        // --- Hardcoded Credentials ---
        const ADMIN_EMAIL = "cnow20874@gmail.com"; const ADMIN_PASSWORD = "hi99wMJpgfHpQjZ"; // Keep secure!
        const ADMIN_PANEL_BASE_URL = "https://cool-moonbeam-685338.netlify.app/"; // Your admin panel URL

        // --- Firebase Refs ---
        const rootRef = ref(db); const chatsRef = ref(db, 'chats'); const adminStatusRef = ref(db, 'adminStatus');

        // --- Initialization and Auth ---
        function initializeAppView() { /* ... (SAME - Checks URL param, sets persistence) ... */
             const urlParams = new URLSearchParams(window.location.search); userToSelectOnLoad = urlParams.get('user');
             if (userToSelectOnLoad) { console.log("URL param found:", userToSelectOnLoad); window.history.replaceState({}, document.title, window.location.pathname); }
             setPersistence(auth, browserLocalPersistence).then(() => { onAuthStateChanged(auth, handleAuthStateChange); }).catch((e) => { console.error("Persistence error:", e); onAuthStateChanged(auth, handleAuthStateChange); });
             sendButton.onclick = handleSendButtonClick; messageInput.onkeydown = handleInputKeydown; logoutButton.onclick = handleLogout; muteButton.onclick = toggleMute; blockUserButton.onclick = toggleBlockUser;
             deleteUserButton.onclick = deleteUser; exportChatButton.onclick = exportChat;
             startCallButton.onclick = adminStartCall; // Add handler for new button
             updateMuteButtonUI(); requestNotificationPermission();
        }

        function handleAuthStateChange(user) { /* ... (SAME - Handles login/logout, calls switchToAdminMode) ... */ }

        // --- UI Mode Switching ---
        function switchToLoginBotMode(showWelcome = false) { /* ... (SAME - Resets UI for login) ... */
            console.log("Switching to Login Bot Mode"); appState = 'LOGIN_BOT_INIT'; cleanupAdminListeners(); hangUpCall(false); userToSelectOnLoad = null;
            mainChatActions.classList.add('hidden'); userStatusDiv.classList.add('hidden'); currentChatUserNameH2.textContent = "Admin Login"; messagesDiv.innerHTML = ''; typingIndicatorDiv.textContent = ''; hideAllCallNotifications(); messageInput.type = "text"; messageInput.placeholder = "Type anything..."; messageInput.disabled = false; sendButton.disabled = false;
            startCallButton.disabled = true; blockUserButton.disabled = true; deleteUserButton.disabled = true; exportChatButton.disabled = true; blockUserButton.textContent = 'Block'; blockUserButton.classList.remove('unblock');
            if (showWelcome) { displayBotMessage("Welcome Admin! Send any message to start."); }
        }
        function switchToAdminMode() { /* ... (SAME - Sets up admin UI, calls loadUserListAndListeners) ... */
             console.log("Switching to Admin Mode"); if (appState.startsWith('ADMIN_')) { if (!globalListeners.users) loadUserListAndListeners(); else updateUserListUI(); return; };
             appState = 'ADMIN_IDLE'; messagesDiv.innerHTML = ''; typingIndicatorDiv.textContent = '';
             mainChatActions.classList.remove('hidden'); userStatusDiv.classList.add('hidden');
             currentChatUserNameH2.textContent = "Select a User"; messageInput.placeholder = "Select user..."; messageInput.type = 'text'; messageInput.disabled = true; sendButton.disabled = true;
             startCallButton.disabled = true; blockUserButton.disabled = true; deleteUserButton.disabled = true; exportChatButton.disabled = true; // Ensure all disabled
             if (!globalListeners.users) { loadUserListAndListeners(); } else { updateUserListUI(); }
             if (currentAdminUser) { adminEmailDisplay.textContent = currentAdminUser.email; }
             setAdminOnlineStatus(true); updateMuteButtonUI(); hideAllCallNotifications();
        }

        // --- Login Bot (SAME) ---
        function handleLoginBotInput() { /* ... */ }
        function verifyCredentials() { /* ... */ }

        // --- Core Event Handlers (SAME) ---
        function handleSendButtonClick() { /* ... */ }
        function handleInputKeydown(e) { /* ... */ }
        function handleLogout() { /* ... */ }

        // --- Message Display (SAME) ---
        function displayMessage(senderType, text, timestamp, msgId, seenByAdmin, clearPrevious) { /* ... */ }
        function displayBotMessage(text, clearPrevious = false) { /* ... */ }
        function scrollToBottom() { /* ... */ }

        // --- Admin Functionality ---

        async function setAdminOnlineStatus(isOnline) { /* ... (SAME) ... */ }

        // Load User List (More logging added)
        function loadUserListAndListeners() {
             if (globalListeners.users) { console.log("User listeners already attached."); return; }
             console.log("Loading user list and attaching listeners...");
             currentUserList = {};
             const usersQuery = query(chatsRef, orderByChild('metadata/lastActive'));
             let initialLoadComplete = false;

             globalListeners.users = onValue(usersQuery, (snapshot) => {
                 console.log("User list snapshot received. Processing...");
                 const users = []; let userCount = 0; let foundUserToSelect = false;
                 if (!snapshot.exists()) {
                     console.log("No users found in 'chats'.");
                 }
                 snapshot.forEach((cs) => {
                     const uid = cs.key; const ud = cs.val();
                     // console.log(`Processing user: ${uid}`, ud); // Verbose log
                     if (ud?.metadata && uid !== 'adminStatus') {
                         userCount++;
                         const name = ud.metadata.userName || `User ${uid.substring(0, 4)}`;
                         const lastActive = ud.metadata.lastActive || 0;
                         const isBlocked = ud.metadata.isBlocked || false;
                         users.push({ userId: uid, userName: name, lastActive, isBlocked });
                         if (!currentUserList[uid]) {
                             // console.log(`Adding new user ${uid} to cache.`);
                             currentUserList[uid] = { userName: name, unreadCount: 0, listenersAttached: false, isBlocked, lastActive };
                             attachUserSpecificListeners(uid); // Attach listener for NEW users
                         } else {
                             // console.log(`Updating existing user ${uid} in cache.`);
                             currentUserList[uid].userName = name;
                             currentUserList[uid].isBlocked = isBlocked;
                             currentUserList[uid].lastActive = lastActive;
                             // Ensure listeners are attached if they somehow got detached
                             if (!currentUserList[uid].listenersAttached) {
                                 console.warn(`Re-attaching listeners for user ${uid}`);
                                 attachUserSpecificListeners(uid);
                             }
                         }
                         if (uid === userToSelectOnLoad) foundUserToSelect = true;
                     } else {
                         // console.log(`Skipping node: ${uid} (missing metadata or is adminStatus)`);
                     }
                 });

                 // --- Remove users from cache that are no longer in the snapshot ---
                 const currentSnapshotKeys = users.map(u => u.userId);
                 Object.keys(currentUserList).forEach(cachedUserId => {
                     if (!currentSnapshotKeys.includes(cachedUserId)) {
                         console.log(`User ${cachedUserId} removed from snapshot. Cleaning up.`);
                         detachUserSpecificListeners(cachedUserId);
                         delete currentUserList[cachedUserId];
                         if(selectedUserId === cachedUserId) resetChatView(); // Reset if selected user was deleted
                     }
                 });
                 // --- End User Removal ---


                 users.sort((a, b) => b.lastActive - a.lastActive);
                 console.log(`Processed ${users.length} users.`);
                 updateUserListUI(users); // Update UI based on current snapshot users
                 userCountDisplay.textContent = userCount; // Display count based on snapshot

                 if (userToSelectOnLoad && foundUserToSelect && !initialLoadComplete) {
                     console.log("Attempting auto-select:", userToSelectOnLoad);
                     selectUserChat(userToSelectOnLoad);
                     userToSelectOnLoad = null;
                 }
                 initialLoadComplete = true;

             }, (error) => { console.error("!!! User list listener error:", error); displayBotMessage("Error loading user list!"); });

             // Global call listener (SAME)
             globalListeners.calls = onChildChanged(chatsRef, (snapshot) => { /* ... */ });
             console.log("User list listeners attached.");
        }

        // Update User List UI (SAME)
        function updateUserListUI(users = null) { /* ... */ }
        // Display User in List (SAME)
        function displayUserInList(userId, userName, isBlocked = false) { /* ... */ }
        // Attach User Listeners (SAME - includes notification trigger)
        function attachUserSpecificListeners(userId) { /* ... */ }
        // Cleanup Listeners (SAME)
        function cleanupAdminListeners() { /* ... */ }
        // Detach User Listeners (SAME)
        function detachUserSpecificListeners(userId) { /* ... */ }
        // Reset Chat View (Handle call button)
        function resetChatView() { /* ... */
             selectedUserId = null; activeCallUserId = null; appState = 'ADMIN_IDLE'; messagesDiv.innerHTML = ''; typingIndicatorDiv.textContent = ''; currentChatUserNameH2.textContent = "Select a User"; userStatusDiv.classList.add('hidden'); mainChatActions.classList.remove('hidden'); messageInput.placeholder = "Select user..."; messageInput.disabled = true; sendButton.disabled = true;
             startCallButton.disabled = true; // Disable call button
             blockUserButton.disabled = true; deleteUserButton.disabled = true; exportChatButton.disabled = true; blockUserButton.textContent = 'Block'; blockUserButton.classList.remove('unblock'); hideAllCallNotifications(); hangUpCall(false);
        }
        // Select User Chat (Handle call button)
        function selectUserChat(userId) { /* ... */
             if (!currentUserList[userId] || !appState.startsWith('ADMIN_')) return; if (activeCallUserId && activeCallUserId !== userId) { alert(`End call with ${currentUserList[activeCallUserId]?.userName || 'user'} first.`); return; }
             if (selectedUserId) { const prevLi = document.getElementById(`user-${selectedUserId}`); if (prevLi) prevLi.classList.remove('active'); }
             selectedUserId = userId; appState = 'ADMIN_CHAT_SELECTED'; const currentLi = document.getElementById(`user-${selectedUserId}`); if (currentLi) currentLi.classList.add('active');
             if (currentUserList[userId]) { currentUserList[userId].unreadCount = 0; updateUnreadIndicator(userId, 0); }
             loadChatForSelectedUser(userId); messageInput.disabled = false; sendButton.disabled = false;
             startCallButton.disabled = !!activeCallUserId; // Enable if no active call
             blockUserButton.disabled = false; deleteUserButton.disabled = false; exportChatButton.disabled = false; messageInput.focus(); messageInput.placeholder = `Reply to ${currentUserList[userId]?.userName || 'User'}...`; updateBlockButtonUI(userId); updateAdminCallUI(currentUserList[userId]?.callState, userId, currentUserList[userId]?.userName);
        }
        // Load Chat History (SAME)
        async function loadChatForSelectedUser(userId) { /* ... */ }
        // Update Status UI (SAME)
        function updateUserStatusUI(status) { /* ... */ }
        // Send Admin Message (SAME)
        function sendAdminMessageToUser() { /* ... */ }
        // Handle Admin Typing (SAME)
        function handleAdminTyping() { /* ... */ }
        // Mark Message Seen (SAME)
        function markMessageAsSeen(userId, msgId) { /* ... */ }
        // Mark Multiple Messages Seen (SAME)
        function markMultipleMessagesAsSeen(userId, msgIds) { /* ... */ }
        // Update Unread Indicator (SAME)
        function updateUnreadIndicator(userId, count) { /* ... */ }

        // --- Chat Actions ---
        // Toggle Block User (SAME)
        function toggleBlockUser() { /* ... */ }
        // Update Block Button UI (SAME)
        function updateBlockButtonUI(userId) { /* ... */ }
        // Delete User (Update count)
        function deleteUser() {
            if (!selectedUserId || appState !== 'ADMIN_CHAT_SELECTED') return;
            const userIdToDelete = selectedUserId; const userName = currentUserList[userIdToDelete]?.userName || 'this user';
            if (confirm(`DELETE USER: ${userName}?\nThis permanently removes the user and chat history.`)) {
                 deleteUserButton.disabled = true; blockUserButton.disabled = true; exportChatButton.disabled = true; startCallButton.disabled = true;
                 const userChatRef = ref(db, `chats/${userIdToDelete}`);
                 remove(userChatRef)
                    .then(() => {
                         console.log(`User ${userIdToDelete} deleted.`); alert(`User ${userName} deleted.`);
                         delete currentUserList[userIdToDelete]; // Remove from local cache
                         const li = document.getElementById(`user-${userIdToDelete}`); if (li) li.remove();
                         // *** UPDATE USER COUNT DISPLAY ***
                         const currentCount = Object.keys(currentUserList).length;
                         userCountDisplay.textContent = currentCount;
                         resetChatView();
                     })
                     .catch(error => {
                          console.error(`Delete user ${userIdToDelete} error:`, error); alert(`Failed to delete ${userName}.`);
                          if(selectedUserId === userIdToDelete) { deleteUserButton.disabled = false; blockUserButton.disabled = false; exportChatButton.disabled = false; startCallButton.disabled = false; }
                     });
            }
        }
        // Export Chat (SAME)
        async function exportChat() { /* ... */ }


        // --- WebRTC Call Handling ---

        // Admin Starts Call
        async function adminStartCall() {
            if (!selectedUserId || activeCallUserId || appState !== 'ADMIN_CHAT_SELECTED') {
                 console.warn("Cannot start call. No user selected, call active, or wrong state.");
                 return;
            }

            const userIdToCall = selectedUserId;
            const userName = currentUserList[userIdToCall]?.userName || 'User';
            console.log(`Admin initiating call with ${userName} (${userIdToCall})...`);

            startCallButton.disabled = true; // Disable button during initiation
            showCallingUI(userIdToCall, userName); // Show "Calling..." UI

            try {
                await createAdminPeerConnection(userIdToCall);
                if (!peerConnection) throw new Error("PeerConnection creation failed.");

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                console.log("Admin offer created and set.");

                const callData = {
                    state: 'admin-ringing', // New state for admin initiated call
                    initiator: 'admin',
                    timestamp: serverTimestamp(),
                    offer: { type: offer.type, sdp: offer.sdp }, // Send offer
                    answer: null, iceCandidates: null, endedBy: null
                };

                 const targetCallRef = ref(db, `chats/${userIdToCall}/call`);
                 await remove(targetCallRef); // Clean previous call data first
                 await set(targetCallRef, callData);
                 console.log("Admin call offer sent to Firebase.");

                 // Listen for the user's answer and ICE candidates
                 listenForUserAnswer(userIdToCall); // Specific listener for answer
                 listenForUserIceCandidates(userIdToCall); // Reuse existing ICE listener

            } catch (error) {
                 console.error("Error starting admin call:", error);
                 displayBotMessage(`Error starting call with ${userName}.`);
                 hangUpCall(true); // Signal end on Firebase if initiation failed
                 hideCallingUI(userIdToCall); // Remove "Calling..." UI
                 // Re-enable button if user still selected
                  if(selectedUserId === userIdToCall) startCallButton.disabled = false;
            }
        }

        // Listen specifically for the user's answer when admin initiates
        function listenForUserAnswer(userId) {
            if (!userId || !peerConnection) return;

            const answerRef = ref(db, `chats/${userId}/call/answer`);
            cleanupSpecificListener(userId, 'answer'); // Clean previous listener if any

            callSignalListeners[userId] = callSignalListeners[userId] || {};
            callSignalListeners[userId].answer = onValue(answerRef, async (snapshot) => {
                const answer = snapshot.val();
                // Check PC expects an answer (signalingState should be 'have-local-offer')
                if (answer && peerConnection && peerConnection.signalingState === 'have-local-offer') {
                    console.log(`Received answer from ${userId}:`, answer);
                    try {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        console.log("Remote description (user answer) set.");
                        // Update Firebase state to active (optional, could rely on ICE connection)
                        // update(ref(db, `chats/${userId}/call`), { state: 'active' });
                        hideCallingUI(userId); // Remove "Calling..." UI
                        showActiveCallUI(userId, currentUserList[userId]?.userName); // Show "Active" UI
                    } catch (error) {
                        console.error(`Error setting remote description (answer) for ${userId}:`, error);
                         hangUpCall(true); // End call if answer is invalid
                    }
                }
            }, (error) => {
                 console.error(`Error listening for answer from ${userId}:`, error);
                 cleanupSpecificListener(userId, 'answer');
            });
            console.log(`Listening for answer from ${userId}`);
        }

        // Show UI indicating admin is calling the user
        function showCallingUI(userId, userName) {
            if (!userId) return;
            hideAllCallNotifications(); // Clear others

            const div = document.createElement('div');
            div.id = `call-calling-${userId}`; // Unique ID for calling state
            div.classList.add('call-alert', 'calling'); // Use 'calling' class for styling
            div.innerHTML = `
                <span>Calling <strong>${userName}</strong>...</span>
                <div class="button-group">
                    <button class="cancel">Cancel</button>
                </div>`;
            callNotificationsContainer.appendChild(div);
            div.querySelector('.cancel').onclick = () => hangUpCall(true); // Cancel signals end
        }

        // Hide the "Calling..." UI
        function hideCallingUI(userId) {
             if (!userId) return;
             const div = document.getElementById(`call-calling-${userId}`);
             if (div) div.remove();
        }


        // Create Peer Connection (SAME)
        async function createAdminPeerConnection(callUserId) { /* ... */ }
        // Handle Incoming Call (SAME - Triggers notification/ringtone)
        function handleIncomingCall(userId, userName, callData) { /* ... */ }
        // Join Incoming Call (SAME - Sets remote desc (offer), creates answer)
        async function joinIncomingCall(userId, userName, offerData, alertElement) { /* ... */ }
        // Listen For User ICE Candidates (SAME)
        function listenForUserIceCandidates(userId) { /* ... */ }
        // Cleanup ICE Listener (SAME)
        function cleanupUserIceListener(userId) { /* ... */ }
        // Cleanup specific listener type
         function cleanupSpecificListener(userId, type) { // type = 'answer' or 'ice'
             if (userId && callSignalListeners[userId]?.[type]) {
                 const listenerRefPath = type === 'answer' ? `chats/${userId}/call/answer` : `chats/${userId}/call/iceCandidates/user`;
                 const eventType = type === 'answer' ? 'value' : 'child_added';
                 off(ref(db, listenerRefPath), eventType, callSignalListeners[userId][type]);
                 delete callSignalListeners[userId][type];
                 if (Object.keys(callSignalListeners[userId]).length === 0) {
                     delete callSignalListeners[userId];
                 }
                 console.log(`Cleaned up ${type} listener for ${userId}`);
             }
         }
        // Reject Incoming Call (SAME)
        function rejectIncomingCall(userId, alertElement) { /* ... */ }
        // Hang Up Call (Handles cleanup, updates state)
        function hangUpCall(signalFirebase = true) { /* ... */
             const userIdToHangUp = activeCallUserId;
             if (!userIdToHangUp && !peerConnection) return; console.log(`Hanging up ${userIdToHangUp}. Signal: ${signalFirebase}`);
             if (peerConnection) { peerConnection.close(); peerConnection = null; } if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; localAudio.srcObject = null; } remoteAudio.srcObject = null;
             if (userIdToHangUp) { cleanupUserIceListener(userIdToHangUp); cleanupSpecificListener(userIdToHangUp, 'answer'); } // Clean up answer listener too
             activeCallUserId = null;
             if (signalFirebase && userIdToHangUp) { update(ref(db, `chats/${userIdToHangUp}/call`), { state: 'ended', endedBy: 'admin', endTimestamp: serverTimestamp() }).catch(e => console.error("Signal end error:", e)); }
             hideActiveCallUI(userIdToHangUp); hideCallingUI(userIdToHangUp); // Hide both potential UIs
              // Re-enable call button if a user is selected
             if (selectedUserId) startCallButton.disabled = false;
        }
        // Update Admin Call UI (Handles all states including 'admin-ringing')
        function updateAdminCallUI(callState, userId, userName) { /* ... */
             if (!appState.startsWith('ADMIN_') || !userId) return;
             const state = callState?.state || 'idle';
             const incomingAlert = document.getElementById(`call-alert-${userId}`);
             const activeAlert = document.getElementById(`call-active-${userId}`);
             const callingAlert = document.getElementById(`call-calling-${userId}`); // Check for calling UI

             // Disable start call button if *any* call interaction is happening for selected user
             if (userId === selectedUserId) {
                 startCallButton.disabled = (state !== 'idle' && state !== 'ended');
             }

             // --- Incoming Call Logic ---
             if (state === 'ringing' && callState.initiator === 'user') {
                 if (!incomingAlert && !activeCallUserId && !callingAlert) { // Don't show if busy OR already calling this user
                      handleIncomingCall(userId, userName, callState);
                 } else if ((activeCallUserId && activeCallUserId !== userId) || callingAlert) {
                      rejectIncomingCall(userId, incomingAlert); // Reject if busy or already calling
                 }
             } else {
                 if (incomingAlert) { ringtoneAudio.pause(); incomingAlert.remove(); }
             }

             // --- Admin Ringing Logic ---
             if (state === 'admin-ringing' && callState.initiator === 'admin') {
                  if (!callingAlert && !activeCallUserId) { // Show only if not already calling/active
                     showCallingUI(userId, userName);
                  }
             } else {
                 if (callingAlert) callingAlert.remove(); // Remove if state changes
             }


             // --- Active Call Logic ---
             if (state === 'active') {
                 if (userId === activeCallUserId && !activeAlert) { // Show only if this is the active call
                      hideCallingUI(userId); // Ensure calling UI is gone
                      showActiveCallUI(userId, userName);
                 } else if (activeAlert && userId !== activeCallUserId) {
                     // Edge case: another user's call became active unexpectedly? Hang up local?
                     console.warn(`Unexpected active call state for non-active user ${userId}`);
                 }
             } else {
                 if (activeAlert && userId === activeCallUserId) { // Only remove if it matches the active call ID
                      activeAlert.remove();
                      hangUpCall(false); // Clean up if UI is removed externally
                 }
             }

             // --- Ended/Idle Cleanup ---
             if (state === 'ended' || state === 'idle') {
                 if (incomingAlert) incomingAlert.remove();
                 if (callingAlert) callingAlert.remove(); // Remove calling UI too
                 if (activeAlert && userId === activeCallUserId) { // Check ID before removing active UI
                      activeAlert.remove();
                      hangUpCall(false); // Clean up if call ends
                 } else if (activeAlert && userId !== activeCallUserId) {
                     // Stale active UI? Remove it.
                     activeAlert.remove();
                 }
             }
        }
        // Show Active Call UI (SAME)
        function showActiveCallUI(userId, userName) { /* ... */ }
        // Hide Active Call UI (SAME)
        function hideActiveCallUI(userId) { /* ... */ }
        // Hide All Call Notifications (Also hide calling UI)
        function hideAllCallNotifications() { /* ... */
             callNotificationsContainer.innerHTML = ''; ringtoneAudio.pause(); ringtoneAudio.currentTime = 0;
        }

        // --- Mute and Notifications ---
        function toggleMute() { /* ... */ }
        function updateMuteButtonUI() { /* ... */ }
        function requestNotificationPermission() { /* ... */ }
        function showNotification(message) { /* ... (SAME Browser Notification logic) ... */ }

        // --- Conceptual Placeholder for Required User Panel Change (Email Trigger) ---
        // In User.html's setupFirebaseConnection or a similar initial connection point:
        /*
        async function setupFirebaseConnection() {
            // ... (existing setup) ...
            try {
                await set(userMetadataRef, { ... });

                // --- CHECK ADMIN STATUS FOR EMAIL NOTIFICATION ---
                const adminOnlineStatusRef = ref(db, 'adminStatus/online');
                get(adminOnlineStatusRef).then(snapshot => {
                    if (snapshot.exists() && snapshot.val() === false) {
                        console.log("Admin is offline. ** SIMULATING EMAIL TRIGGER on User Connect **");
                        const uniqueUrl = `${ADMIN_PANEL_BASE_URL}?user=${userId}`; // Use constant
                        console.log(`Email would be sent to ${ADMIN_EMAIL} for user ${userName} (${userId}) connecting. Link: ${uniqueUrl}`);

                        // **** FIREBASE FUNCTION NEEDED HERE ****
                        // Trigger Function: { type: 'userConnect', userId, userName, uniqueUrl, adminEmail: ADMIN_EMAIL }
                    } else {
                         console.log("Admin is online, no connection email needed.");
                    }
                }).catch(error => {
                     console.error("Error checking admin status on connect:", error);
                });
                // --- END EMAIL CHECK ---

                // ... (rest of setup: presence, listeners, etc.) ...

            } catch (error) { // ... existing error handling ... }
        }
        */

        // --- Run App ---
        initializeAppView();

    </script>

</body>
</html>