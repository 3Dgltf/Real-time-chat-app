<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>">
    <style>
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html, body { height: 100%; overflow: hidden; }
        body { background: linear-gradient(to right, #6a11cb, #2575fc); display: flex; color: #fff; }

         /* --- Wrapper --- */
         .admin-view-wrapper { width: 100%; height: 100%; display: flex; background-color: rgba(0,0,0,0.1); }

        /* --- Sidebar --- */
        .sidebar { width: 280px; background: rgba(255, 255, 255, 0.08); border-right: 1px solid rgba(255, 255, 255, 0.2); display: flex; flex-direction: column; flex-shrink: 0; color: #eee; height: 100%; overflow: hidden; }
        .sidebar .content-wrapper { padding: 15px; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .admin-header { border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 15px; margin-bottom: 15px; flex-shrink: 0; }
        .admin-header h3 { margin-bottom: 10px; font-size: 1.3em; color: #fff; }
        #admin-profile { font-size: 0.85em; margin-bottom: 5px; word-break: break-all; } #admin-profile strong { color: #fff; }
        #user-count { font-size: 0.85em; margin-bottom: 10px; color: #ccc;}
        .sidebar-actions button { width: 100%; margin-bottom: 8px; font-size: 0.9em; padding: 8px 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; border: 1px solid rgba(255,255,255,0.3); }
        #logoutButton { background-color: #ff4f81; color: white;} #logoutButton:hover { background-color: #e03060; }
        #muteButton { background-color: #ffd700; color: #333; } #muteButton:hover { background-color: #e0a800;} #muteButton.muted { background-color: #ff8c00; color: white; }
        .user-list-header { padding-bottom: 5px; font-weight: bold; border-bottom: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 5px; font-size: 0.9em; flex-shrink: 0; }
        .user-list-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
        .user-list-container::-webkit-scrollbar { width: 6px; } .user-list-container::-webkit-scrollbar-track { background: transparent; } .user-list-container::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.3); border-radius: 3px; }
        #user-list { list-style: none; padding: 0; margin: 0; }
        #user-list li { padding: 10px 0px 10px 5px; cursor: pointer; border-bottom: 1px solid rgba(255, 255, 255, 0.1); transition: background-color 0.2s ease; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        #user-list li:hover { background-color: rgba(255, 255, 255, 0.1); }
        #user-list li.active { background-color: #2575fc; color: white; font-weight: 500; } #user-list li.active:hover { background-color: #1a5fce; }
        #user-list li .user-name { overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 10px; white-space: nowrap;}
        #user-list li .indicators { display: flex; align-items: center; gap: 5px; flex-shrink: 0; } /* Container for indicators */
        #user-list li .unread-indicator { min-width: 18px; height: 18px; background-color: #ff4f81; border-radius: 50%; color: white; font-size: 0.7em; font-weight: bold; text-align: center; line-height: 18px; padding: 0 4px; opacity: 0; transform: scale(0.5); transition: opacity 0.3s ease, transform 0.3s ease; }
        #user-list li .unread-indicator.visible { opacity: 1; transform: scale(1); }
        #user-list li .blocked-indicator { font-size: 0.8em; color: #ffc107; font-weight: bold; background: rgba(0,0,0,0.3); padding: 1px 4px; border-radius: 3px;}

        /* --- Chat Container --- */
        .chat-container { flex: 1; height: 100%; background-color: transparent; display: flex; flex-direction: column; position: relative; overflow: hidden; padding: 0; }

        /* Chat Header */
        .chat-header { padding: 10px 15px; background-color: rgba(0, 0, 0, 0.2); color: white; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .chat-header-left { display: flex; flex-direction: column; }
        .chat-header-left h2 { font-size: 1.1em; margin: 0 0 2px 0; color: #fff; font-weight: 500;}
        #user-status { font-size: 0.75em; color: #ccc; }
        #user-status .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; display: inline-block; vertical-align: middle; background-color: #aaa; transition: background-color 0.3s ease; box-shadow: 0 0 2px rgba(0,0,0,0.4); }
        #user-status .status-dot.online { background-color: #33ff33; } #user-status .status-dot.offline { background-color: #aaa; }

        /* Chat Actions */
        .chat-actions { display: flex; align-items: center; gap: 6px; }
        .chat-actions button { padding: 4px 8px; font-size: 0.75em; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 4px; background-color: rgba(255, 255, 255, 0.1); color: #fff; transition: background-color 0.2s ease, border-color 0.2s ease; line-height: 1.3; }
        .chat-actions button:hover:not(:disabled) { background-color: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.6); }
        .chat-actions button:disabled { border-color: rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.4); cursor: not-allowed; background-color: rgba(0, 0, 0, 0.1); }
        #clearChatHistoryButton { border-color: #ffc107; color: #ffc107; } #clearChatHistoryButton:hover:not(:disabled) { background-color: rgba(255, 193, 7, 0.2); }
        #blockUserButton { border-color: #dc3545; color: #dc3545; } #blockUserButton:hover:not(:disabled) { background-color: rgba(220, 53, 69, 0.2); }
        #blockUserButton.unblock { border-color: #28a745; color: #28a745; } #blockUserButton.unblock:hover:not(:disabled) { background-color: rgba(40, 167, 69, 0.2); }
        #deleteUserButton { border-color: #ff4f81; color: #ff4f81; } /* Adjusted color */ #deleteUserButton:hover:not(:disabled) { background-color: rgba(255, 79, 129, 0.2); }
        #exportChatButton { border-color: #17a2b8; color: #17a2b8; } #exportChatButton:hover:not(:disabled) { background-color: rgba(23, 162, 184, 0.2); }

        /* Messages Area */
        .messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
        .messages::-webkit-scrollbar { width: 6px; } .messages::-webkit-scrollbar-track { background: transparent; } .messages::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.4); border-radius: 3px; }

        /* Message Styles */
        .message { padding: 10px 14px; border-radius: 10px; max-width: 80%; word-wrap: break-word; line-height: 1.4; font-size: 0.95em; position: relative; background: rgba(255, 255, 255, 0.2); color: #fff; animation: fadeIn 0.3s ease-out; opacity: 0; animation-fill-mode: forwards; }
        .message p { margin: 0; padding: 0; }
        .message.sent { align-self: flex-end; background-color: #00c6ff; color: #000; border-bottom-right-radius: 5px; }
        .message.received { align-self: flex-start; background-color: #ffd700; color: #000; border-bottom-left-radius: 5px; }
        .message .timestamp { font-size: 0.7em; display: block; margin-top: 4px; text-align: right; }
        .message.sent .timestamp { color: rgba(0, 0, 0, 0.6); } .message.received .timestamp { color: rgba(0, 0, 0, 0.7); }
        .message.system, .message.error, .message.success { align-self: center; background-color: rgba(0,0,0,0.5); color: #eee; font-style: italic; text-align: center; max-width: 90%; padding: 8px 12px; font-size: 0.9em; border-radius: 8px; }
        .message.system .timestamp, .message.error .timestamp, .message.success .timestamp { display: none; }
        .message.error { background-color: rgba(220, 53, 69, 0.8); font-weight: bold; font-style: normal;}
        .message.success { background-color: rgba(40, 167, 69, 0.8); font-weight: bold; font-style: normal;}
        .message.received .timestamp::after { content: ''; display: inline-block; width: 14px; height: 14px; margin-left: 5px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 15.1"><path fill="%23aaccaa" d="M15.6 3.4l-1.1-1.1-8.9 8.9L1.8 7.4l-1.1 1.1 4.8 4.8 10.1-10z"/></svg>'); background-repeat: no-repeat; background-size: contain; vertical-align: text-bottom; opacity: 0.7; }
        .message.received.seen .timestamp::after { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 15.1"><path fill="%2333ff33" d="M17.6 3.4L16.5 2.3C13.1-1.1 7.1 2.1 4.7 4.5l-1.9 1.9-1.1 1.1 4.8 4.8 1.1-1.1 1.9-1.9c2.4-2.4 8.4-5.6 10.1-3.9zm-4.8 4.8l-1.1 1.1-4.8-4.8L8 3.4l1.1-1.1 4.8 4.8z"/></svg>'); opacity: 1; }
        .message .delete-msg-btn { position: absolute; top: -5px; font-size: 0.8em; background: rgba(0, 0, 0, 0.4); color: white; border: none; border-radius: 50%; width: 16px; height: 16px; line-height: 16px; text-align: center; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 1; }
        .message.sent .delete-msg-btn { right: -5px; } .message:hover .delete-msg-btn { opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Typing Indicator */
        #typing-indicator { padding: 0 15px 5px; font-style: italic; color: #ccc; height: 20px; font-size: 0.85em; text-align: left; flex-shrink: 0; }

        /* --- Input Area Container (holds input row + call button/status) --- */
        .input-area-container {
             padding: 10px 15px 15px 15px; /* Padding around input elements */
             flex-shrink: 0; /* Prevent shrinking */
             background-color: rgba(0, 0, 0, 0.1); /* Subtle background */
             border-top: 1px solid rgba(255, 255, 255, 0.1); /* Subtle separator */
        }

        /* Input Row */
        .input-container { display: flex; gap: 10px; margin-bottom: 10px; /* Space below input */ }
        #message-input { flex: 1; padding: 10px 15px; border: none; border-radius: 10px; background-color: rgba(255, 255, 255, 0.9); color: #333; font-size: 1em; }
        #message-input:disabled { background-color: #e0e0e0; cursor: not-allowed; opacity: 0.7; }
        #send-button { padding: 10px 15px; border: none; border-radius: 10px; background-color: #00ffcc; color: #000; cursor: pointer; font-weight: bold; transition: background-color 0.2s ease; }
        #send-button:hover:not(:disabled) { background-color: #00ccaa; }
        #send-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.7; }

        /* --- NEW: Audio Call Button (User Panel Style) --- */
        .audio-call-button-container { /* Container for the button */
             margin-bottom: 5px; /* Space before call status */
        }
        #adminAudioCallButton {
            background-color: #ff4f81; /* User panel style */
            color: white; width: 100%;
            padding: 11px; border: none; border-radius: 10px; cursor: pointer;
            font-weight: bold; transition: background-color 0.2s ease, opacity 0.2s ease;
            font-size: 0.95em;
        }
        #adminAudioCallButton:hover:not(:disabled) { background-color: #f03a6a; }
        #adminAudioCallButton:disabled { background-color: #aaa; cursor: not-allowed; opacity: 0.7; }

        /* Call Status */
        #call-status-display { /* New ID for status below button */
             text-align: center; font-weight: bold; min-height: 18px;
             font-size: 0.8em; color: rgba(255, 255, 255, 0.8);
        }


        /* Call Notifications Overlay */
        #call-notifications-container { position: absolute; top: 60px; right: 15px; z-index: 100; display: flex; flex-direction: column; gap: 10px; max-width: 280px; }
        .call-alert { padding: 10px 12px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 3px 10px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 0.85em; backdrop-filter: blur(5px); }
        .call-alert.incoming { background-color: rgba(40, 167, 69, 0.85); } .call-alert.active { background-color: rgba(0, 123, 255, 0.85); } .call-alert.calling { background-color: rgba(255, 193, 7, 0.85); color: #000;}
        .call-alert span strong { font-weight: bold; }
        .call-alert .button-group { display: flex; gap: 6px; }
        .call-alert button { margin-left: 4px; background-color: rgba(255,255,255,0.85); color: #333; padding: 4px 8px; font-size: 0.8em; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s ease; }
        .call-alert button:hover { background-color: rgba(255,255,255, 1); }
        .call-alert button.join { background-color: #33ff33; color: #000;} .call-alert button.join:hover { background-color: #00e600; }
        .call-alert button.reject, .call-alert button.end, .call-alert button.cancel { background-color: #ff4f81; color: white; }
        .call-alert button.reject:hover, .call-alert button.end:hover, .call-alert button.cancel:hover { background-color: #e03060; }

        /* Utility */
        .hidden { display: none !important; }
        /* Hidden Audio Elements */
        .hidden-audio { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        /* Mobile Adjustments */
         @media (max-width: 768px) {
             html, body { height: auto; overflow: auto; }
             .admin-view-wrapper { flex-direction: column; height: auto; min-height: 100vh; }
             .sidebar { width: 100% !important; height: auto; max-height: 45vh; border-right: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); order: 1; overflow: hidden; }
             .sidebar .content-wrapper { padding: 10px 15px; }
             .user-list-container { overflow-y: auto; flex-grow: 1; }
             .chat-container { order: 2; flex: 1; min-height: 55vh; height: auto; }
             .chat-header { padding: 10px 15px; } .chat-header-left h2 { font-size: 1.0em;}
             .chat-actions { flex-wrap: wrap; gap: 4px; justify-content: flex-end;} .chat-actions button { font-size: 0.7em; padding: 3px 6px; margin-left: 3px;}
             .messages { padding: 15px; flex-grow: 1; }
             .input-area-container { padding: 10px 15px; }
             .input-container input, .input-container button { font-size: 0.9em; }
             #adminAudioCallButton { padding: 10px; font-size: 0.9em; } /* Adjust new call button */
             #call-status-display { font-size: 0.75em; }
             #call-notifications-container { top: 50px; right: 10px; max-width: 180px;}
             .call-alert { padding: 8px 10px; font-size: 0.8em; } .call-alert button { padding: 3px 6px; font-size: 0.75em;}
         }
    </style>
</head>
<body>

    <!-- Main container -->
    <div class="admin-view-wrapper">

        <!-- Sidebar -->
        <aside class="sidebar" id="admin-sidebar">
            <div class="content-wrapper">
                <div class="admin-header">
                    <h3>Admin Panel</h3>
                    <div id="admin-profile">Logged in as: <strong id="admin-email-display"></strong></div>
                    <div id="user-count">Total Users: <strong id="user-count-display">0</strong></div>
                    <div class="sidebar-actions">
                        <button id="muteButton">Mute Alerts</button>
                        <button id="logoutButton">Logout</button>
                    </div>
                </div>
                <div class="user-list-header">Users</div>
                <div class="user-list-container">
                    <ul id="user-list">
                         <li class="disabled" style="text-align: center; color: #6c757d; padding: 20px;">Login to view users</li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Chat Container -->
        <div class="chat-container" id="main-chat-area">
            <!-- Header -->
            <div class="chat-header" id="main-chat-header">
                <div class="chat-header-left">
                     <h2 id="current-chat-userName">Admin Login / Select User</h2>
                     <div id="user-status" class="hidden">User: <span class="status-dot offline" title="Offline"></span></div>
                </div>
                <!-- Admin actions -->
                <div class="chat-actions hidden" id="main-chat-actions">
                     <!-- Call button moved below input -->
                     <button id="clearChatHistoryButton" disabled title="Clear Chat History">Clear</button>
                     <button id="blockUserButton" disabled title="Block/Unblock User">Block</button>
                     <button id="deleteUserButton" disabled title="Delete User & History">Delete User</button>
                     <button id="exportChatButton" disabled title="Export Chat History">Export</button>
                </div>
            </div>

             <!-- Typing Indicator -->
             <div id="typing-indicator" class="typing-indicator"></div>

             <!-- Messages -->
             <div class="messages" id="messages"></div>

            <!-- Input Area Container -->
            <div class="input-area-container" id="main-input-area-container">
                 <!-- Input Row -->
                 <div class="input-container" id="main-input-container">
                    <input type="text" id="message-input" placeholder="Type message to login or chat..." autocomplete="off">
                    <button type="button" id="send-button">Send</button>
                 </div>
                 <!-- NEW Audio Call Button -->
                 <div class="audio-call-button-container">
                     <button id="adminAudioCallButton" disabled>Audio Call</button>
                 </div>
                 <!-- Call Status Display -->
                 <div id="call-status-display"></div>
            </div>
        </div>
    </div>

     <!-- Call Notifications (Overlay) -->
     <div id="call-notifications-container"></div>

    <!-- Audio elements -->
    <audio id="ringtone" src="ringtone.mp3" preload="auto"></audio>
    <audio id="localAudio" autoplay muted class="hidden-audio"></audio>
    <audio id="remoteAudio" autoplay class="hidden-audio"></audio>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK Imports (Use specific versions)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, onChildAdded, onChildChanged, onChildRemoved, serverTimestamp, query, orderByChild, limitToLast, update, remove, off, get, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js"; // Added onChildRemoved

        // Firebase configuration
        const firebaseConfig = { /* ... SAME ... */
             apiKey: "AIzaSyA5mBW5mXff46acu01BbPmZh8LGGXV42v8", authDomain: "chat-app-ddecb.firebaseapp.com", databaseURL: "https://chat-app-ddecb-default-rtdb.firebaseio.com", projectId: "chat-app-ddecb", storageBucket: "chat-app-ddecb.firebasestorage.app", messagingSenderId: "534760202357", appId: "1:534760202357:web:da7d90561af1c4220a183c", measurementId: "G-MCSSLKG71W"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- DOM Elements ---
        const adminSidebar = document.getElementById('admin-sidebar');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const adminEmailDisplay = document.getElementById('admin-email-display');
        const userCountDisplay = document.getElementById('user-count-display');
        const logoutButton = document.getElementById('logoutButton');
        const userListUL = document.getElementById('user-list');
        const mainChatHeader = document.getElementById('main-chat-header');
        const currentChatUserNameH2 = document.getElementById('current-chat-userName');
        const userStatusDiv = document.getElementById('user-status');
        const userStatusSpan = userStatusDiv.querySelector('.status-dot');
        const mainChatActions = document.getElementById('main-chat-actions');
        const typingIndicatorDiv = document.getElementById('typing-indicator');
        const clearChatHistoryButton = document.getElementById('clearChatHistoryButton');
        const blockUserButton = document.getElementById('blockUserButton');
        const deleteUserButton = document.getElementById('deleteUserButton');
        const exportChatButton = document.getElementById('exportChatButton');
        const adminAudioCallButton = document.getElementById('adminAudioCallButton'); // New Call Button
        const callStatusDisplay = document.getElementById('call-status-display'); // New Call Status Div
        const callNotificationsContainer = document.getElementById('call-notifications-container');
        const ringtoneAudio = document.getElementById('ringtone');
        const muteButton = document.getElementById('muteButton');
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');

        // --- State Variables ---
        let appState = 'INITIAL'; // 'INITIAL', 'LOGIN_EMAIL', 'LOGIN_PASSWORD', 'LOGGING_IN', 'ADMIN_IDLE', 'ADMIN_CHAT_SELECTED'
        let tempLoginEmail = '';
        let selectedUserId = null;
        let currentUserList = {}; // Cache: { userId: { userName, unreadCount, listenersAttached: {messages, status, call}, isBlocked, lastActive, statusData, callData } }
        let typingTimeout = null;
        let isMuted = localStorage.getItem('adminMuted') === 'true';
        let globalListeners = { users: {}, calls: null }; // users will hold child listeners refs
        let currentAdminUser = null;
        let botMessageTimeout;
        let peerConnection = null; let localStream = null; let activeCallUserId = null;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let callSignalListeners = {};
        let userToSelectOnLoad = null;
        let originalSendButtonHandler = null;

        // --- Constants ---
        const ADMIN_EMAIL = "cnow20874@gmail.com"; const ADMIN_PASSWORD = "hi99wMJpgfHpQjZ";
        const ADMIN_PANEL_BASE_URL = "https://cool-moonbeam-685338.netlify.app/";

        // --- Firebase Refs ---
        const rootRef = ref(db); const chatsRef = ref(db, 'chats'); const adminStatusRef = ref(db, 'adminStatus'); const connectedRef = ref(db, '.info/connected'); // Added connectedRef

        // --- Log Helper ---
        function log(level, ...args) { console[level](`[Admin v6]`, ...args); }

        // --- Initialization and Auth ---
        function initializeAppView() {
             log('info', "Initializing Admin View...");
             const urlParams = new URLSearchParams(window.location.search); userToSelectOnLoad = urlParams.get('user');
             if (userToSelectOnLoad) { log('info',"URL param found:", userToSelectOnLoad); window.history.replaceState({}, document.title, window.location.pathname); }

             setPersistence(auth, browserLocalPersistence).then(() => {
                 onAuthStateChanged(auth, handleAuthStateChange);
             }).catch((e) => { log('error',"Persistence error:", e); onAuthStateChanged(auth, handleAuthStateChange); });

             // Attach listeners to CORRECTED element IDs
             sendButton.onclick = handleSendAttempt;
             messageInput.onkeypress = (e) => { if (e.key === 'Enter') handleSendAttempt(); };
             logoutButton.onclick = handleLogout;
             muteButton.onclick = toggleMute;
             // Action button listeners attached AFTER login
             updateMuteButtonUI();
             requestNotificationPermission();
             setUIState('INITIAL');
        }

        function handleAuthStateChange(user) {
            log('info', `Auth State Changed: User ${user ? user.email : 'null'}. Current App State: ${appState}`);
            clearTimeout(botMessageTimeout);

            if (user && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                 log('info', "Admin Authenticated:", user.email);
                 currentAdminUser = user;
                 if (!appState.startsWith('ADMIN_')) {
                     log('info', "Transitioning to ADMIN_IDLE state...");
                     setUIState('LOGGING_IN'); displaySystemMessage("Login successful. Loading...", 'success', true);
                     setTimeout(() => { setUIState('ADMIN_IDLE'); initializeDashboardFunctionality(); }, 500);
                 } else { log('info', "Already in admin state."); setAdminOnlineStatus(true); if (!globalListeners.users.added) { initializeDashboardFunctionality(); } } // Re-init if listeners missing
            } else {
                 log('info', "Admin Not Authenticated."); if (currentAdminUser) { setAdminOnlineStatus(false); } currentAdminUser = null;
                 cleanupAllDashboardListeners(); setUIState('INITIAL');
            }
        }

        // --- UI State Management ---
        function setUIState(newState) {
            log('info', `Setting UI State: ${newState}`);
            const previousState = appState; appState = newState;

            // Defaults
            logoutButton.classList.add('hidden'); messageInput.disabled = true; sendButton.disabled = true; sendButton.textContent = 'Send'; messageInput.type = 'text'; messageInput.placeholder = 'Loading...'; messageInput.value = ''; messageInput.onkeypress = null; sendButton.onclick = null;
            if(originalSendButtonHandler) { sendButton.removeEventListener('click', originalSendButtonHandler); originalSendButtonHandler = null; }
            adminAudioCallButton.disabled = true; clearChatHistoryButton.disabled = true; blockUserButton.disabled = true; blockUserButton.textContent = 'Block'; blockUserButton.classList.remove('unblock'); deleteUserButton.disabled = true; exportChatButton.disabled = true; mainChatActions.classList.add('hidden');
            userListUL.querySelectorAll('li').forEach(li => li.classList.add('disabled'));

            switch(newState) {
                case 'INITIAL':
                    userListUL.innerHTML = '<li class="disabled" style="text-align: center; color: #6c757d; padding: 20px;">Login to view users</li>'; currentChatUserNameH2.textContent = "Admin Login Required"; userStatusDiv.classList.add('hidden'); messagesDiv.innerHTML = ''; displaySystemMessage("Type a message or click Send to login.", 'system');
                    messageInput.disabled = false; sendButton.disabled = false; messageInput.placeholder = 'Type message to login...'; sendButton.onclick = handleSendAttempt; messageInput.onkeypress = (e) => { if (e.key === 'Enter') handleSendAttempt(); };
                    break;
                case 'LOGIN_EMAIL':
                    messagesDiv.innerHTML = ''; displaySystemMessage("Enter Admin Email:", 'system'); messageInput.disabled = false; sendButton.disabled = false; messageInput.type = 'email'; messageInput.placeholder = 'admin@example.com'; sendButton.textContent = 'Next'; sendButton.onclick = handleEmailInput; messageInput.onkeypress = (e) => { if (e.key === 'Enter') handleEmailInput(); }; messageInput.focus();
                    break;
                case 'LOGIN_PASSWORD':
                    messagesDiv.innerHTML = ''; displaySystemMessage(`Email: ${tempLoginEmail}\nEnter Password:`, 'system'); messageInput.disabled = false; sendButton.disabled = false; messageInput.type = 'password'; messageInput.placeholder = 'Password'; sendButton.textContent = 'Login'; sendButton.onclick = handlePasswordInput; messageInput.onkeypress = (e) => { if (e.key === 'Enter') handlePasswordInput(); }; messageInput.focus();
                    break;
                case 'LOGGING_IN':
                    displaySystemMessage("Verifying...", 'system'); messageInput.disabled = true; sendButton.disabled = true; sendButton.textContent = 'Verifying...';
                    break;
                case 'ADMIN_IDLE':
                    logoutButton.classList.remove('hidden'); userListUL.querySelectorAll('li').forEach(li => li.classList.remove('disabled')); mainChatActions.classList.remove('hidden');
                    currentChatUserNameH2.textContent = "Select a User"; userStatusDiv.classList.add('hidden');
                    if (previousState !== 'ADMIN_CHAT_SELECTED') { messagesDiv.innerHTML = ''; displaySystemMessage("Select a user from the list.", 'system'); }
                    messageInput.disabled = true; sendButton.disabled = true; messageInput.placeholder = 'Select a user...'; messageInput.type = 'text';
                    // Ensure all action buttons are disabled
                    adminAudioCallButton.disabled = true; clearChatHistoryButton.disabled = true; blockUserButton.disabled = true; deleteUserButton.disabled = true; exportChatButton.disabled = true;
                    break;
                case 'ADMIN_CHAT_SELECTED':
                    logoutButton.classList.remove('hidden'); userListUL.querySelectorAll('li').forEach(li => li.classList.remove('disabled')); mainChatActions.classList.remove('hidden');
                    messageInput.disabled = false; sendButton.disabled = false; messageInput.placeholder = 'Type reply...'; messageInput.type = 'text';
                    originalSendButtonHandler = sendMessageAdminInternal; sendButton.addEventListener('click', originalSendButtonHandler);
                    messageInput.onkeypress = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessageAdminInternal(); } else if (selectedUserId) { setAdminTyping(true); } };
                    messageInput.oninput = () => { if (appState === 'ADMIN_CHAT_SELECTED' && selectedUserId) { setAdminTyping(true); } };
                    // Enable action buttons (call button depends on activeCallUserId)
                    adminAudioCallButton.disabled = !!activeCallUserId; // Use the new button ID
                    clearChatHistoryButton.disabled = false; exportChatButton.disabled = false; deleteUserButton.disabled = false;
                    updateBlockButtonUI(); // Handles block/unblock state and disabling
                    userStatusDiv.classList.remove('hidden');
                    break;
            }
        }

        // --- Inline Login Flow (SAME) ---
        function handleSendAttempt() { if (appState === 'INITIAL') { log('info', "Send -> Login."); messageInput.value = ''; initiateLoginFlow(); } }
        function initiateLoginFlow() { if (appState !== 'INITIAL') return; setUIState('LOGIN_EMAIL'); }
        function handleEmailInput() { if (appState !== 'LOGIN_EMAIL') return; tempLoginEmail = messageInput.value.trim(); if (!tempLoginEmail || !/\S+@\S+\.\S+/.test(tempLoginEmail)) { displaySystemMessage("Invalid email.", 'error'); messageInput.focus(); return; } log('debug', `Email: ${tempLoginEmail}`); setUIState('LOGIN_PASSWORD'); }
        function handlePasswordInput() { if (appState !== 'LOGIN_PASSWORD') return; const password = messageInput.value; if (!password) { displaySystemMessage("Password needed.", 'error'); messageInput.focus(); return; } log('info', `Attempting login for ${tempLoginEmail}`); setUIState('LOGGING_IN'); auth.signInWithEmailAndPassword(tempLoginEmail, password).then(() => {}).catch((error) => { log('error', "Login Failed:", error.code); let msg = `Login Failed: ${error.code}`; if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') msg = "Error: Incorrect email/password."; else if (error.code === 'auth/network-request-failed') msg = "Error: Network problem."; tempLoginEmail = ''; setUIState('INITIAL'); displaySystemMessage(msg, 'error', false); }); }

        // --- Dashboard Functionality Setup ---
        function initializeDashboardFunctionality() {
            if (!appState.startsWith('ADMIN_')) { log('warn','Dashboard init skipped: Not logged in.'); return; }
            log('info', "Initializing Dashboard Functionality...");
            try {
                setupAdminPresence();
                loadUserListAndListeners(); // Uses child_* listeners now
                setupGlobalCallListener();
                // Attach action button listeners
                clearChatHistoryButton.onclick = handleClearChatHistory;
                blockUserButton.onclick = toggleBlockUser;
                deleteUserButton.onclick = deleteUser;
                exportChatButton.onclick = exportChat;
                adminAudioCallButton.onclick = adminStartCall; // Attach to new button

                log('info', "Dashboard Functionality Initialized.");
            } catch (dashError) { log('error', "CRITICAL ERROR during dashboard FUNCTIONALITY setup:", dashError); displaySystemMessage(`CRITICAL: Setup failed: ${dashError.message}.`, 'error'); }
         }

        // --- System Message Display (SAME) ---
        function displaySystemMessage(text, type = 'system', clearPrevious = false) { /* ... */ }

        // --- Admin Presence (SAME) ---
        function setupAdminPresence() { /* ... */ }

        // --- User List Handling (NEW: Using child_* listeners) ---
        function loadUserListAndListeners() {
             // Prevent duplicate listeners
             if (globalListeners.users.added || globalListeners.users.changed || globalListeners.users.removed) {
                 log('warn', "User list listeners seem already attached.");
                 return;
             }
             log('info', "Attaching User List Listeners (child_*)...");
             currentUserList = {}; // Reset cache
             userListUL.innerHTML = '<li class="disabled" style="text-align: center; color: #6c757d; padding: 20px;">Loading users...</li>';
             let initialUsersProcessed = false; // To handle initial placeholder removal

             // --- Child Added Listener ---
             globalListeners.users.added = onChildAdded(chatsRef, (snapshot) => {
                 if (!appState.startsWith('ADMIN_')) return;
                 const userId = snapshot.key;
                 const userData = snapshot.val();
                 log('debug', `Child Added: ${userId}`, userData);

                 if (userData?.metadata && userId !== 'adminStatus') {
                     // Remove placeholder if this is the first user
                     if (!initialUsersProcessed && userListUL.querySelector('li:not([data-user-id])')) {
                         userListUL.innerHTML = '';
                     }
                     initialUsersProcessed = true;

                     const name = userData.metadata.userName || `User ${userId.substring(0, 4)}`;
                     const lastActive = userData.metadata.lastActive || 0;
                     const isBlocked = userData.metadata.isBlocked || false;

                     // Add/Update cache
                     currentUserList[userId] = {
                         ...(currentUserList[userId] || {}), // Preserve existing listeners if any
                         userName: name,
                         isBlocked: isBlocked,
                         lastActive: lastActive,
                         // Reset unread count on add/reload? Or rely on message listener? Let's reset.
                         unreadCount: 0
                     };

                     // Add/Update UI List Item
                     updateUserListItem(userId);

                     // Attach specific listeners if not already attached
                     if (!currentUserList[userId].listenersAttached) {
                         attachUserSpecificListeners(userId);
                     } else {
                         // If re-added, ensure listeners are still valid (might not be needed)
                         log('debug', `User ${userId} re-added, listeners should persist.`);
                     }

                     // Auto-select if needed
                     if (userId === userToSelectOnLoad) {
                         log('info', `Auto-selecting user ${userId} from child_added.`);
                         selectUserChat(userId);
                         userToSelectOnLoad = null;
                     }
                     updateUserCount(); // Update count display
                 } else {
                     log('debug', `Skipping added child: ${userId} (no metadata or adminStatus)`);
                 }
             }, (error) => { log('error', "!!! User child_added listener error:", error); });

             // --- Child Changed Listener ---
             globalListeners.users.changed = onChildChanged(chatsRef, (snapshot) => {
                 if (!appState.startsWith('ADMIN_')) return;
                 const userId = snapshot.key;
                 const userData = snapshot.val();
                 log('debug', `Child Changed: ${userId}`, userData);

                 if (currentUserList[userId] && userData?.metadata && userId !== 'adminStatus') {
                     const name = userData.metadata.userName || currentUserList[userId].userName; // Keep old name if new is missing
                     const lastActive = userData.metadata.lastActive || currentUserList[userId].lastActive;
                     const isBlocked = userData.metadata.isBlocked || false; // Default to false if removed

                     let needsUIUpdate = false;
                     if (currentUserList[userId].userName !== name) { currentUserList[userId].userName = name; needsUIUpdate = true; }
                     if (currentUserList[userId].isBlocked !== isBlocked) { currentUserList[userId].isBlocked = isBlocked; needsUIUpdate = true; }
                     if (currentUserList[userId].lastActive !== lastActive) { currentUserList[userId].lastActive = lastActive; /* No UI update needed just for this */ }

                     if (needsUIUpdate) {
                         updateUserListItem(userId);
                     }
                     // Update header/actions if the *selected* user's block status changed
                     if (userId === selectedUserId) {
                         currentChatUserNameH2.textContent = name; // Update header name
                         updateBlockButtonUI(); // Update block button state/text
                     }
                 } else if (currentUserList[userId] && (!userData || !userData.metadata)) {
                     // Metadata might have been removed - treat as user removal?
                     log('warn', `Metadata removed for user ${userId}. Treating as removal.`);
                     handleUserRemoval(userId);
                 }
             }, (error) => { log('error', "!!! User child_changed listener error:", error); });

             // --- Child Removed Listener ---
             globalListeners.users.removed = onChildRemoved(chatsRef, (snapshot) => {
                 if (!appState.startsWith('ADMIN_')) return;
                 const userId = snapshot.key;
                 log('info', `Child Removed: ${userId}`);
                 handleUserRemoval(userId);
             }, (error) => { log('error', "!!! User child_removed listener error:", error); });

             log('info', "User list child_* listeners attached.");
        }

        // Helper to handle user removal logic
        function handleUserRemoval(userId) {
            if (!currentUserList[userId]) return; // Already removed?
            log('info', `Handling removal of user ${userId}`);
            detachUserSpecificListeners(userId); // Clean up listeners
            delete currentUserList[userId]; // Remove from cache
            const li = document.getElementById(`user-${userId}`);
            if (li) li.remove(); // Remove from UI
            if (selectedUserId === userId) { // If selected user removed
                resetChatView();
            }
            updateUserCount(); // Update count display
            // Check if list is now empty
            if (Object.keys(currentUserList).length === 0) {
                 userListUL.innerHTML = '<li class="disabled" style="text-align: center; color: #6c757d; padding: 20px;">No active users</li>';
            }
        }

        // Helper to Add/Update a single list item in the UI
        function updateUserListItem(userId) {
            if (!currentUserList[userId] || !userListUL) return;

            const userData = currentUserList[userId];
            let li = document.getElementById(`user-${userId}`);

            if (!li) { // Create if doesn't exist
                li = document.createElement('li');
                li.id = `user-${userId}`;
                li.dataset.userId = userId;
                // TODO: Insert sorted? For now, just append. Sorting might need full redraw.
                userListUL.appendChild(li);
                li.onclick = () => selectUserChat(userId);
            }

            // Update content
            const name = userData.userName || 'Unknown';
            const isBlocked = userData.isBlocked || false;
            const hasUnread = userData.unreadCount > 0; // Use unreadCount from cache

            li.innerHTML = `
                <span class="user-name" title="${name} (${userId})">${name}</span>
                <span class="indicators">
                    <span class="unread-indicator ${hasUnread ? 'visible' : ''}" title="Unread messages">${hasUnread ? (userData.unreadCount > 9 ? '9+' : userData.unreadCount) : ''}</span>
                    ${isBlocked ? '<span class="blocked-indicator" title="User blocked">Blocked</span>' : ''}
                </span>`;

            li.classList.toggle('active', userId === selectedUserId);
            li.classList.remove('disabled'); // Ensure not disabled if being updated/added
        }

        // Helper to update user count display
        function updateUserCount() {
             const count = Object.keys(currentUserList).length;
             userCountDisplay.textContent = count;
        }


        // Setup Global Call Listener (SAME)
        function setupGlobalCallListener() { /* ... */ }
        // Attach User Listeners (Revised unread logic)
        function attachUserSpecificListeners(userId) {
             if (!currentUserList[userId] || currentUserList[userId].listenersAttached) return;
             log('debug', `Attaching listeners for ${userId}`);
             const uc = currentUserList[userId];
             const msgRef = ref(db, `chats/${userId}/messages`);
             const statusRef = ref(db, `chats/${userId}/status`);
             const callRef = ref(db, `chats/${userId}/call`);

             uc.listenersAttached = { // Store refs for cleanup
                 messages: msgRef,
                 status: statusRef,
                 call: callRef
             };

             // --- Message Listener (Focus on Unread Count) ---
             // Listen to all added messages
             onChildAdded(msgRef, (snapshot) => {
                 if (!appState.startsWith('ADMIN_') || !currentUserList[userId]) return; // Check state & cache
                 const msg = snapshot.val(); const msgId = snapshot.key;
                 if (!msg) return;

                 const isNewUnseen = msg.sender === 'user' && !msg.seenByAdmin;

                 if (userId === selectedUserId) {
                      // Display if chat is open
                      if (!document.getElementById(`msg-${msgId}`)){ displayMessageInternal(msg.sender === 'admin' ? 'sent' : 'received', msg.text, msg.timestamp, msgId, msg.seenByAdmin); }
                      // Mark seen if it's new & unseen
                      if (isNewUnseen) { markMessageAsSeen(userId, msgId); }
                      // Ensure unread count is 0 if viewing
                      if (uc.unreadCount > 0) { uc.unreadCount = 0; updateUnreadIndicator(userId, 0); }
                 } else if (isNewUnseen) {
                      // Increment count and update UI if chat not open
                      uc.unreadCount = (uc.unreadCount || 0) + 1;
                      updateUnreadIndicator(userId, uc.unreadCount);
                      if (!isMuted) { showNotification(`Msg from ${uc.userName}`); }
                 }
             }, e => log('error', `Msg listener error ${userId}:`, e));

             // --- Status Listener ---
             onValue(statusRef, (s) => { if (!appState.startsWith('ADMIN_') || !currentUserList[userId]) return; uc.statusData = s.val(); if (userId === selectedUserId) { updateUserStatusUI(uc.statusData); } }, e => log('error', `Status listener error ${userId}:`, e));

             // --- Call Listener ---
             onValue(callRef, (s) => { if (!appState.startsWith('ADMIN_') || !currentUserList[userId]) return; const cs = s.val(); uc.callData = cs; updateAdminCallUI(cs, userId, uc.userName); if (activeCallUserId === userId && (!cs || cs.state === 'ended' || cs.state === 'idle')) { hangUpCall(false); } }, e => log('error', `Call listener error ${userId}:`, e));

             log('debug', `Listeners attached for ${userId}`);
        }
        // Cleanup Listeners (Revised for new structure)
        function cleanupAllDashboardListeners() {
             log('info', 'Cleaning ALL dashboard listeners...');
             try {
                 // Detach global listeners using stored refs
                 if (globalListeners.users.added) off(chatsRef, 'child_added', globalListeners.users.added);
                 if (globalListeners.users.changed) off(chatsRef, 'child_changed', globalListeners.users.changed);
                 if (globalListeners.users.removed) off(chatsRef, 'child_removed', globalListeners.users.removed);
                 globalListeners.users = {}; // Reset refs
                 if (globalListeners.calls) { off(chatsRef, 'child_changed', globalListeners.calls); globalListeners.calls = null; }
                 connectedRef?.off();
                 if(presenceRef) { presenceRef.onDisconnect().cancel().catch(e=>log('warn','Err cancel onDisconnect',e)); presenceRef.set(null).catch(e=>log('warn','Err clear presence',e)); }
                 // Detach all individual user listeners
                 Object.keys(currentUserList).forEach(userId => detachUserSpecificListeners(userId));
                 currentUserList = {}; // Reset cache
                 clearTimeout(typingTimeout);
                 hideAllCallNotifications(); hangUpCall(false);
                 // Clear JS handlers
                 if (sendButton && originalSendButtonHandler) { sendButton.removeEventListener('click', originalSendButtonHandler); originalSendButtonHandler = null; }
                 sendButton.onclick=null; messageInput.onkeypress=null; messageInput.oninput=null;
                 clearChatHistoryButton.onclick=null; blockUserButton.onclick=null; deleteUserButton.onclick=null; exportChatButton.onclick=null; adminAudioCallButton.onclick=null; // Clear new call button handler
             } catch (e) { log('error', "Error during cleanupAllDashboardListeners:", e); }
        }
        function detachUserSpecificListeners(userId) {
             const uc = currentUserList[userId];
             if (!uc || !uc.listenersAttached) return; // Already detached or never attached
             log('debug', `Detaching listeners for ${userId}`);
             try {
                 if (uc.listenersAttached.messages) off(uc.listenersAttached.messages, 'child_added');
                 if (uc.listenersAttached.status) off(uc.listenersAttached.status, 'value');
                 if (uc.listenersAttached.call) off(uc.listenersAttached.call, 'value');
             } catch(e) { log('warn', `Error detaching listeners for ${userId}:`, e); }
             uc.listenersAttached = null; // Mark as detached
        }

        // Reset Chat View (Handles new call button)
        function resetChatView() { /* ... */
             selectedUserId = null; activeCallUserId = null; appState = 'ADMIN_IDLE'; messagesDiv.innerHTML = ''; typingIndicatorDiv.textContent = ''; currentChatUserNameH2.textContent = "Select a User"; userStatusDiv.classList.add('hidden'); mainChatActions.classList.remove('hidden'); messageInput.placeholder = "Select user..."; messageInput.disabled = true; sendButton.disabled = true;
             adminAudioCallButton.disabled = true; clearChatHistoryButton.disabled = true; blockUserButton.disabled = true; deleteUserButton.disabled = true; exportChatButton.disabled = true; blockUserButton.textContent = 'Block'; blockUserButton.classList.remove('unblock'); hideAllCallNotifications(); hangUpCall(false);
             displaySystemMessage("Select a user from the list.", 'system', true);
             callStatusDisplay.textContent = ''; // Clear call status text
        }
        // Select User Chat (Handles new call button)
        function selectUserChat(userId) { /* ... */
             if (!currentUserList[userId] || !appState.startsWith('ADMIN_')) return; if (activeCallUserId && activeCallUserId !== userId) { alert(`End call with ${currentUserList[activeCallUserId]?.userName || 'user'} first.`); return; }
             if (selectedUserId === userId) { log('debug', `User ${userId} already selected.`); return; }
             log('info', `Selecting user: ${userId}`);
             if (selectedUserId) { const prevLi = document.getElementById(`user-${selectedUserId}`); if (prevLi) prevLi.classList.remove('active'); }
             selectedUserId = userId; const currentLi = document.getElementById(`user-${selectedUserId}`); if (currentLi) currentLi.classList.add('active');
             if (currentUserList[userId]) { currentUserList[userId].unreadCount = 0; updateUnreadIndicator(userId, 0); } // Update cache and UI for unread
             loadChatForSelectedUser(userId);
             setUIState('ADMIN_CHAT_SELECTED'); // Set state AFTER loading potentially
             messageInput.focus(); messageInput.placeholder = `Reply to ${currentUserList[userId]?.userName || 'User'}...`;
             currentChatUserNameH2.textContent = currentUserList[userId]?.userName || `User ${userId.substring(0,4)}`;
             updateUserStatusUI(currentUserList[userId]?.statusData); // Use cached status data
             updateAdminCallUI(currentUserList[userId]?.callData, userId, currentUserList[userId]?.userName); // Use cached call data
             callStatusDisplay.textContent = ''; // Clear call status text initially
        }
        // Load Chat History (SAME)
        async function loadChatForSelectedUser(userId) { /* ... */ }
        // Update Status UI (SAME)
        function updateUserStatusUI(status) { /* ... */ }
        // Send Admin Message (SAME)
        function sendMessageAdminInternal() { /* ... */ }
        // Display Message Internal (SAME)
        function displayMessageInternal(senderType, text, timestamp, msgId, seenByAdmin) { /* ... */ }
        // Handle Admin Typing (SAME)
        function setAdminTyping(isTyping) { /* ... */ }
        // Mark Message Seen (SAME)
        function markMessageAsSeen(userId, msgId) { /* ... */ }
        // Mark Multiple Messages Seen (SAME)
        function markMultipleMessagesAsSeen(userId, msgIds) { /* ... */ }
        // Update Unread Indicator (Uses unreadCount)
        function updateUnreadIndicator(userId, count) {
             const li = document.getElementById(`user-${userId}`); if (!li) return;
             const indicator = li.querySelector('.unread-indicator'); if (!indicator) return;
             const numCount = Number(count) || 0;
             indicator.textContent = numCount > 0 ? (numCount > 9 ? '9+' : numCount) : '';
             indicator.classList.toggle('visible', numCount > 0);
        }

        // --- Chat Actions ---
        // Toggle Block User (SAME)
        function toggleBlockUser() { /* ... */ }
        // Update Block Button UI (SAME)
        function updateBlockButtonUI() { /* ... */ }
        // Clear Chat History (Uses new button ID)
        function handleClearChatHistory() { /* ... (uses clearChatHistoryButton) ... */ }
        // Delete User (Updates count)
        function deleteUser() { /* ... (SAME - updates count) ... */ }
        // Export Chat (SAME)
        async function exportChat() { /* ... */ }
        // Handle Delete Message (SAME)
        function handleDeleteMessage(userId, messageId) { /* ... */ }


        // --- WebRTC Call Handling (Revised for New Button & Status) ---
        // Admin Starts Call (Uses new button ID)
        async function adminStartCall() {
            if (!selectedUserId || activeCallUserId || appState !== 'ADMIN_CHAT_SELECTED') return;
            const userIdToCall = selectedUserId; const userName = currentUserList[userIdToCall]?.userName || 'User';
            log('info', `Admin initiating call with ${userName} (${userIdToCall})...`);
            adminAudioCallButton.disabled = true; // Disable NEW button
            callStatusDisplay.textContent = `Calling ${userName}...`; // Update status text
            // showCallingUI(userIdToCall, userName); // Use status text instead of overlay? Or keep overlay? Let's use text for now.

            try {
                await createAdminPeerConnection(userIdToCall); if (!peerConnection) throw new Error("PC failed.");
                const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer);
                const callData = { state: 'admin-ringing', initiator: 'admin', timestamp: serverTimestamp(), offer: { type: offer.type, sdp: offer.sdp }, answer: null, iceCandidates: null, endedBy: null };
                const targetCallRef = ref(db, `chats/${userIdToCall}/call`); await remove(targetCallRef); await set(targetCallRef, callData);
                listenForUserAnswer(userIdToCall); listenForUserIceCandidates(userIdToCall);
                // Update button text while calling
                adminAudioCallButton.textContent = 'Cancel Call';
                adminAudioCallButton.disabled = false; // Allow cancelling
                adminAudioCallButton.onclick = () => hangUpCall(true); // Change handler to cancel

            } catch (error) { log('error', "Admin call start error:", error); displaySystemMessage(`Error starting call.`, 'error'); hangUpCall(true); callStatusDisplay.textContent = 'Call failed'; adminAudioCallButton.textContent = 'Audio Call'; adminAudioCallButton.onclick = adminStartCall; if(selectedUserId === userIdToCall) adminAudioCallButton.disabled = false; }
        }
        // Listen For User Answer (Update new status/button)
        function listenForUserAnswer(userId) { /* ... */
             if (!userId || !peerConnection) return; const answerRef = ref(db, `chats/${userId}/call/answer`); cleanupSpecificListener(userId, 'answer'); callSignalListeners[userId] = callSignalListeners[userId] || {};
             callSignalListeners[userId].answer = onValue(answerRef, async (s) => { const a = s.val(); if (a && peerConnection && peerConnection.signalingState === 'have-local-offer') { log('info', `Received answer from ${userId}`); try { await peerConnection.setRemoteDescription(new RTCSessionDescription(a)); log('debug',"Remote desc (answer) set."); callStatusDisplay.textContent = 'Call Active'; adminAudioCallButton.textContent = 'End Call'; adminAudioCallButton.disabled = false; adminAudioCallButton.onclick = () => hangUpCall(true); } catch (e) { log('error',`Set answer error ${userId}:`, e); hangUpCall(true); } } }, (e) => { log('error',`Answer listener error ${userId}:`, e); cleanupSpecificListener(userId, 'answer'); }); log('debug',`Listening for answer from ${userId}`);
        }
        // Show/Hide Calling UI (Not needed if using status text)
        // function showCallingUI(userId, userName) { /* ... */ }
        // function hideCallingUI(userId) { /* ... */ }
        // Create Peer Connection (SAME)
        async function createAdminPeerConnection(callUserId) { /* ... */ }
        // Handle Incoming Call (Uses notification overlay)
        function handleIncomingCall(userId, userName, callData) { /* ... (SAME - uses overlay) ... */ }
        // Join Incoming Call (Update new status/button)
        async function joinIncomingCall(userId, userName, offerData, alertElement) { /* ... */
             ringtoneAudio.pause(); if (alertElement) alertElement.remove(); if (activeCallUserId) { alert("Already in call."); rejectIncomingCall(userId, null); return; }
             if (selectedUserId !== userId) { selectUserChat(userId); } // Switch chat view
             log('info', `Admin joining call with ${userName} (${userId})`);
             // showActiveCallUI(userId, userName); // Use status text instead?
             callStatusDisplay.textContent = `Connecting to ${userName}...`;
             adminAudioCallButton.disabled = true; // Disable while connecting

             try { await createAdminPeerConnection(userId); if (!peerConnection) return; if (!offerData || !offerData.sdp) throw new Error("Invalid offer."); await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData)); const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer); const callUpdates = { state: 'active', answer: { type: answer.type, sdp: answer.sdp }, joinedBy: 'admin', joinTimestamp: serverTimestamp() }; await update(ref(db, `chats/${userId}/call`), callUpdates); listenForUserIceCandidates(userId);
                 // Update UI on successful connection
                 callStatusDisplay.textContent = 'Call Active';
                 adminAudioCallButton.textContent = 'End Call';
                 adminAudioCallButton.disabled = false;
                 adminAudioCallButton.onclick = () => hangUpCall(true);
             } catch (error) { log('error', "Join call error:", error); displaySystemMessage(`Error joining call.`, 'error'); hangUpCall(true); callStatusDisplay.textContent = 'Join failed'; adminAudioCallButton.textContent = 'Audio Call'; adminAudioCallButton.onclick = adminStartCall; if(selectedUserId === userId) adminAudioCallButton.disabled = false; }
        }
        // Listen For User ICE Candidates (SAME)
        function listenForUserIceCandidates(userId) { /* ... */ }
        // Cleanup ICE Listener (SAME)
        function cleanupUserIceListener(userId) { /* ... */ }
        // Cleanup Specific Listener (SAME)
        function cleanupSpecificListener(userId, type) { /* ... */ }
        // Reject Incoming Call (SAME)
        function rejectIncomingCall(userId, alertElement) { /* ... */ }
        // Hang Up Call (Update new status/button)
        function hangUpCall(signalFirebase = true) { /* ... */
             const uid = activeCallUserId; if (!uid && !peerConnection) return; log('info', `Hanging up ${uid}. Signal: ${signalFirebase}`);
             // ... (Close PC, stop streams, cleanup listeners) ...
             if (peerConnection) { peerConnection.close(); peerConnection = null; } if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; localAudio.srcObject = null; } remoteAudio.srcObject = null;
             if (uid) { cleanupUserIceListener(uid); cleanupSpecificListener(uid, 'answer'); }
             activeCallUserId = null; // *** Reset active call ID ***
             if (signalFirebase && uid) { update(ref(db, `chats/${uid}/call`), { state: 'ended', endedBy: 'admin', endTimestamp: serverTimestamp() }).catch(e => console.error("Signal end error:", e)); }
             hideActiveCallUI(uid); // Hide overlay notification if any
             // Reset the main call button and status text
             callStatusDisplay.textContent = 'Call Ended';
             adminAudioCallButton.textContent = 'Audio Call';
             adminAudioCallButton.onclick = adminStartCall; // Reset handler
             adminAudioCallButton.disabled = !selectedUserId; // Disable if no user selected
             // Clear status after a delay
             setTimeout(() => { if (!activeCallUserId) callStatusDisplay.textContent = ''; }, 2500);
        }
        // Update Admin Call UI (Manages new button/status)
        function updateAdminCallUI(callState, userId, userName) {
             if (!appState.startsWith('ADMIN_') || !userId) return;
             const state = callState?.state || 'idle';
             const isSelectedUser = (userId === selectedUserId);

             // Manage overlay notifications (Incoming)
             const incomingAlert = document.getElementById(`call-alert-${userId}`);
             if (state === 'ringing' && callState.initiator === 'user') { if (!incomingAlert && !activeCallUserId) { handleIncomingCall(userId, userName, callState); } else if (activeCallUserId && activeCallUserId !== userId) { rejectIncomingCall(userId, incomingAlert); } }
             else { if (incomingAlert) { ringtoneAudio.pause(); incomingAlert.remove(); } }

             // Manage main call button and status text ONLY for the SELECTED user
             if (isSelectedUser) {
                 adminAudioCallButton.onclick = adminStartCall; // Default handler
                 switch (state) {
                     case 'ringing': // User calling admin
                         callStatusDisplay.textContent = `${userName} is calling...`;
                         adminAudioCallButton.textContent = 'Join Call'; // Change button action? No, use overlay.
                         adminAudioCallButton.disabled = true; // Disable main button while overlay shows
                         break;
                     case 'admin-ringing': // Admin calling user
                         callStatusDisplay.textContent = `Calling ${userName}...`;
                         adminAudioCallButton.textContent = 'Cancel Call';
                         adminAudioCallButton.disabled = false;
                         adminAudioCallButton.onclick = () => hangUpCall(true); // Change handler
                         break;
                     case 'active':
                         callStatusDisplay.textContent = 'Call Active';
                         adminAudioCallButton.textContent = 'End Call';
                         adminAudioCallButton.disabled = false;
                         adminAudioCallButton.onclick = () => hangUpCall(true); // Change handler
                         break;
                     case 'ended':
                         callStatusDisplay.textContent = 'Call Ended';
                         adminAudioCallButton.textContent = 'Audio Call';
                         adminAudioCallButton.disabled = false; // Re-enable for new call
                         setTimeout(() => { if (selectedUserId === userId && !activeCallUserId) callStatusDisplay.textContent = ''; }, 2500);
                         break;
                     case 'idle':
                     default:
                         callStatusDisplay.textContent = '';
                         adminAudioCallButton.textContent = 'Audio Call';
                         adminAudioCallButton.disabled = !!activeCallUserId; // Disable only if another call is active
                         break;
                 }
             } else {
                 // If the call update is for a non-selected user, just ensure overlay is handled (done above)
             }

             // Handle external hangup if active call ends
             if (userId === activeCallUserId && (state === 'ended' || state === 'idle')) {
                 hangUpCall(false); // Clean up local state
             }
        }
        // Show/Hide Active Call UI (Overlay - kept for consistency)
        function showActiveCallUI(userId, userName) { /* ... (Shows overlay notification) ... */ }
        function hideActiveCallUI(userId) { /* ... (Removes overlay notification) ... */ }
        // Hide All Call Notifications (Overlay)
        function hideAllCallNotifications() { /* ... */ }

        // --- Mute and Notifications ---
        function toggleMute() { isMuted = !isMuted; localStorage.setItem('adminMuted', isMuted); updateMuteButtonUI(); if (isMuted) { ringtoneAudio.pause(); ringtoneAudio.currentTime = 0; } log('info', `Mute toggled: ${isMuted}`); }
        function updateMuteButtonUI() { muteButton.textContent = isMuted ? 'Unmute Alerts' : 'Mute Alerts'; muteButton.classList.toggle('muted', isMuted); }
        function requestNotificationPermission() { /* ... */ }
        function showNotification(message) { if (isMuted) { log('debug', 'Notification muted:', message); return; } requestNotificationPermission(); if ('Notification' in window && Notification.permission === 'granted' && document.hidden) { const n = new Notification('Admin Panel Alert', { body: message, tag: 'admin-chat-alert' }); } else if ('Notification' in window && Notification.permission === 'granted' && !document.hidden) { log('debug',"Notification suppressed (tab active):", message); } else { /* Denied or not supported */ } }

        // --- Utility Functions ---
        function formatTimestamp(timestamp, full = false) { /* ... */ }
        function scrollToBottom(element = messagesDiv) { /* ... */ }

        // --- Conceptual Email Trigger (For User Panel) ---
        /* User Panel: setupFirebaseConnection() / sendMessage()
            get(ref(db, 'adminStatus/online')).then(snap => {
                if (snap.exists() && snap.val() === false) {
                    const uniqueUrl = `${ADMIN_PANEL_BASE_URL}?user=${userId}`;
                    console.log(`** EMAIL TRIGGER: To ${ADMIN_EMAIL}, User: ${userName}, Link: ${uniqueUrl}`);
                    // Trigger Firebase Function here
                }
            });
        */

        // --- Run App ---
        initializeAppView();

    </script>

</body>
</html>