<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <style>
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html, body { height: 100%; overflow: hidden; }
        body { background: linear-gradient(to right, #6a11cb, #2575fc); display: flex; color: #fff; }

         /* --- Wrapper --- */
         .admin-view-wrapper { width: 100%; height: 100%; display: flex; background-color: rgba(0,0,0,0.1); }

        /* --- Sidebar --- */
        .sidebar { width: 280px; background: rgba(255, 255, 255, 0.08); border-right: 1px solid rgba(255, 255, 255, 0.2); display: flex; flex-direction: column; flex-shrink: 0; color: #eee; height: 100%; overflow: hidden; }
        .sidebar .content-wrapper { padding: 15px; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .admin-header { border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 15px; margin-bottom: 15px; flex-shrink: 0; }
        .admin-header h3 { margin-bottom: 10px; font-size: 1.3em; color: #fff; }
        #admin-profile { font-size: 0.85em; margin-bottom: 5px; word-break: break-all; } #admin-profile strong { color: #fff; }
        #user-count { font-size: 0.85em; margin-bottom: 10px; color: #ccc;}
        .sidebar-actions button { width: 100%; margin-bottom: 8px; font-size: 0.9em; padding: 8px 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; border: 1px solid rgba(255,255,255,0.3); }
        #logoutButton { background-color: #ff4f81; color: white;} #logoutButton:hover { background-color: #e03060; }
        #muteButton { background-color: #ffd700; color: #333; } #muteButton:hover { background-color: #e0a800;} #muteButton.muted { background-color: #ff8c00; color: white; }
        .user-list-header { padding-bottom: 5px; font-weight: bold; border-bottom: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 5px; font-size: 0.9em; flex-shrink: 0; }
        .user-list-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
        .user-list-container::-webkit-scrollbar { width: 6px; } .user-list-container::-webkit-scrollbar-track { background: transparent; } .user-list-container::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.3); border-radius: 3px; }
        #user-list { list-style: none; padding: 0; margin: 0; }
        #user-list li { padding: 10px 0px 10px 5px; cursor: pointer; border-bottom: 1px solid rgba(255, 255, 255, 0.1); transition: background-color 0.2s ease; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        #user-list li:hover { background-color: rgba(255, 255, 255, 0.1); }
        #user-list li.active { background-color: #2575fc; color: white; font-weight: 500; } #user-list li.active:hover { background-color: #1a5fce; }
        #user-list li .user-name { overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 10px; white-space: nowrap;}
        #user-list li .unread-indicator { min-width: 18px; height: 18px; background-color: #ff4f81; border-radius: 50%; color: white; font-size: 0.7em; font-weight: bold; text-align: center; line-height: 18px; padding: 0 4px; flex-shrink: 0; opacity: 0; transform: scale(0.5); transition: opacity 0.3s ease, transform 0.3s ease; }
        #user-list li .unread-indicator.visible { opacity: 1; transform: scale(1); }

        /* --- Chat Container --- */
        .chat-container { flex: 1; height: 100%; background-color: transparent; display: flex; flex-direction: column; position: relative; overflow: hidden; padding: 0; }

        /* Chat Header */
        .chat-header { padding: 15px 20px; background-color: rgba(0, 0, 0, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.2); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .chat-header-left h2 { margin: 0; font-size: 1.2em; color: #fff; }
        #user-status { font-size: 0.85em; color: #ddd; margin-top: 3px; }
        #user-status .status-dot { width: 9px; height: 9px; border-radius: 50%; margin-right: 5px; display: inline-block; vertical-align: middle; background-color: #aaa; transition: background-color 0.3s ease; box-shadow: 0 0 3px rgba(0,0,0,0.5); }
        #user-status .status-dot.online { background-color: #33ff33; } #user-status .status-dot.offline { background-color: #aaa; }
        /* --- Adjusted Button Styles --- */
        .chat-actions button {
             margin-left: 6px; /* Reduced margin */
             padding: 5px 10px; /* Reduced padding */
             font-size: 0.8em; /* Reduced font size */
             background-color: rgba(255,255,255, 0.2); color: #fff; border: 1px solid rgba(255,255,255,0.3); cursor: pointer; border-radius: 4px; /* Slightly smaller radius */ transition: background-color 0.2s ease;
         }
        .chat-actions button:hover:not(:disabled) { background-color: rgba(255,255,255, 0.35); }
        .chat-actions button:disabled { background-color: rgba(255,255,255, 0.1); color: #aaa; cursor: not-allowed; }
        #blockUserButton { background-color: #ffd700; color: #333;} #blockUserButton.unblock { background-color: #33ff33; color: #000;}
        #deleteUserButton { background-color: #ff4f81; color: white; } /* Renamed ID */
        #exportChatButton { background-color: #00c6ff; color: #000; }

        /* Messages Area */
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
        .messages::-webkit-scrollbar { width: 6px; } .messages::-webkit-scrollbar-track { background: transparent; } .messages::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.4); border-radius: 3px; }

        /* Message Styles */
        .message-wrapper { display: flex; margin-bottom: 12px; max-width: 85%; animation: fadeIn 0.3s ease-out; opacity: 0; animation-fill-mode: forwards; }
        .message-wrapper.sent { align-self: flex-end; } .message-wrapper.received { align-self: flex-start; } .message-wrapper.bot { align-self: flex-start; }
        .message-wrapper p { padding: 10px 15px; border-radius: 15px; word-wrap: break-word; line-height: 1.4; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        .message-wrapper.sent p { background-color: #00c6ff; border-bottom-right-radius: 5px; }
        .message-wrapper.received p { background-color: #ffd700; border-bottom-left-radius: 5px; }
        .message-wrapper.bot p { background-color: rgba(255, 255, 255, 0.8); color: #333; border-bottom-left-radius: 5px; }
        .message-wrapper .timestamp { font-size: 0.7em; color: rgba(255, 255, 255, 0.65); margin-top: 4px; display: block; }
        .message-wrapper.sent .timestamp { text-align: right; padding-right: 5px; }
        .message-wrapper.received .timestamp, .message-wrapper.bot .timestamp { text-align: left; padding-left: 5px; }
        .message-wrapper.bot .timestamp { display: none; }
        /* Seen Checkmarks need SVG URLs added back if removed */
        .message-wrapper.received .timestamp::after { content: ''; display: inline-block; width: 14px; height: 14px; margin-left: 5px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 15.1"><path fill="%23aaccaa" d="M15.6 3.4l-1.1-1.1-8.9 8.9L1.8 7.4l-1.1 1.1 4.8 4.8 10.1-10z"/></svg>'); background-repeat: no-repeat; background-size: contain; vertical-align: text-bottom; opacity: 0.7; }
        .message-wrapper.received.seen .timestamp::after { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 15.1"><path fill="%2333ff33" d="M17.6 3.4L16.5 2.3C13.1-1.1 7.1 2.1 4.7 4.5l-1.9 1.9-1.1 1.1 4.8 4.8 1.1-1.1 1.9-1.9c2.4-2.4 8.4-5.6 10.1-3.9zm-4.8 4.8l-1.1 1.1-4.8-4.8L8 3.4l1.1-1.1 4.8 4.8z"/></svg>'); opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Typing Indicator */
        #typing-indicator { min-height: 18px; font-style: italic; color: rgba(255, 255, 255, 0.75); font-size: 0.85em; padding: 5px 20px; flex-shrink: 0; }

        /* Input Area */
        .input-area { display: flex; gap: 10px; padding: 15px 20px; background-color: rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.2); flex-shrink: 0; }
        .input-area input[type="text"], .input-area input[type="password"] { flex: 1; padding: 12px 15px; border: none; border-radius: 10px; background-color: rgba(255, 255, 255, 0.9); color: #333; outline: none; font-size: 0.95em; }
        .input-area input::placeholder { color: #777; } .input-area input:disabled { background-color: #ddd; cursor: not-allowed; }
        .input-area button { padding: 12px 18px; border-radius: 10px; background-color: #00ffcc; color: #000; font-weight: bold; transition: background-color 0.2s ease; border: none; cursor: pointer; font-size: 0.95em; }
        .input-area button:hover:not(:disabled) { background-color: #00ccaa; } .input-area button:disabled { background-color: #aaa; cursor: not-allowed; opacity: 0.7; }

        /* Call Notifications Overlay */
        #call-notifications-container { position: absolute; top: 70px; right: 15px; z-index: 100; display: flex; flex-direction: column; gap: 10px; max-width: 280px; }
        .call-alert { padding: 12px 15px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 3px 10px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: space-between; gap: 10px; font-size: 0.9em; backdrop-filter: blur(5px); }
        .call-alert.incoming { background-color: rgba(40, 167, 69, 0.85); } .call-alert.active { background-color: rgba(0, 123, 255, 0.85); }
        .call-alert span strong { font-weight: bold; }
        .call-alert .button-group { display: flex; gap: 8px; }
        .call-alert button { margin-left: 5px; background-color: rgba(255,255,255,0.85); color: #333; padding: 5px 10px; font-size: 0.85em; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s ease; }
        .call-alert button:hover { background-color: rgba(255,255,255, 1); }
        .call-alert button.join { background-color: #33ff33; color: #000;} .call-alert button.join:hover { background-color: #00e600; }
        .call-alert button.reject, .call-alert button.end { background-color: #ff4f81; color: white; } .call-alert button.reject:hover, .call-alert button.end:hover { background-color: #e03060; }

        /* Utility */
        .hidden { display: none !important; }
        /* Hidden Audio Elements */
        .hidden-audio { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        /* Mobile Adjustments */
         @media (max-width: 768px) { /* Styles remain the same */
             html, body { height: auto; overflow: auto; }
             .admin-view-wrapper { flex-direction: column; height: auto; min-height: 100vh; }
             .sidebar { width: 100% !important; height: auto; max-height: 45vh; border-right: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); order: 1; overflow: hidden; }
             .sidebar .content-wrapper { padding: 10px 15px; }
             .user-list-container { overflow-y: auto; flex-grow: 1; }
             .chat-container { order: 2; flex: 1; min-height: 55vh; height: auto; }
             .chat-header { padding: 12px 15px; } .chat-header-left h2 { font-size: 1.1em;} .chat-actions button { font-size: 0.75em; padding: 4px 8px; margin-left: 4px;} /* Smaller buttons on mobile */
             .messages { padding: 15px; flex-grow: 1; }
             .input-area { padding: 10px 15px; } .input-area input, .input-area button { font-size: 0.9em; }
             #call-notifications-container { top: 55px; right: 10px; max-width: 200px;}
             .call-alert { padding: 10px; font-size: 0.85em; }
         }
    </style>
</head>
<body>

    <!-- Main container -->
    <div class="admin-view-wrapper">

        <!-- Sidebar -->
        <aside class="sidebar" id="admin-sidebar">
            <div class="content-wrapper">
                <div class="admin-header">
                    <h3>Admin Panel</h3>
                    <div id="admin-profile">Logged in as: <strong id="admin-email-display"></strong></div>
                    <div id="user-count">Total Users: <strong id="user-count-display">0</strong></div>
                    <div class="sidebar-actions">
                        <button id="muteButton">Mute Alerts</button>
                        <button id="logoutButton">Logout</button>
                    </div>
                </div>
                <div class="user-list-header">Users</div>
                <div class="user-list-container">
                    <ul id="user-list"></ul>
                </div>
            </div>
        </aside>

        <!-- Chat Container -->
        <div class="chat-container" id="main-chat-area">
            <!-- Header -->
            <div class="chat-header" id="main-chat-header">
                <div class="chat-header-left">
                     <h2 id="current-chat-userName">Admin Login / Select User</h2>
                     <div id="user-status" class="hidden">User: <span class="status-dot offline" title="Offline"></span></div>
                </div>
                <!-- Admin actions -->
                <div class="chat-header-right chat-actions hidden" id="main-chat-actions">
                     <button id="blockUserButton" disabled>Block</button>
                     <button id="deleteUserButton" disabled>Delete User</button> <!-- Renamed ID -->
                     <button id="exportChatButton" disabled>Export</button>
                </div>
            </div>

             <!-- Typing Indicator -->
             <div id="typing-indicator"></div>

             <!-- Messages -->
            <div class="messages" id="messages"></div>

            <!-- Input Area -->
            <div class="input-area" id="main-input-area">
                <input type="text" id="messageInput" placeholder="Enter credentials or select user..." autocomplete="off">
                <button id="sendButton">Send</button>
            </div>
        </div>
    </div>

     <!-- Call Notifications (Overlay) -->
     <div id="call-notifications-container"></div>

    <!-- Audio elements -->
    <audio id="ringtone" src="ringtone.mp3" preload="auto"></audio>
    <audio id="localAudio" autoplay muted class="hidden-audio"></audio>
    <audio id="remoteAudio" autoplay class="hidden-audio"></audio>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, onChildAdded, onChildChanged, serverTimestamp, query, orderByChild, limitToLast, update, remove, off, get, child } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
             apiKey: "AIzaSyA5mBW5mXff46acu01BbPmZh8LGGXV42v8",
             authDomain: "chat-app-ddecb.firebaseapp.com",
             databaseURL: "https://chat-app-ddecb-default-rtdb.firebaseio.com",
             projectId: "chat-app-ddecb",
             storageBucket: "chat-app-ddecb.firebasestorage.app",
             messagingSenderId: "534760202357",
             appId: "1:534760202357:web:da7d90561af1c4220a183c",
             measurementId: "G-MCSSLKG71W"
         };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- DOM Elements ---
        const adminSidebar = document.getElementById('admin-sidebar');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const adminEmailDisplay = document.getElementById('admin-email-display');
        const userCountDisplay = document.getElementById('user-count-display');
        const logoutButton = document.getElementById('logoutButton');
        const userListUL = document.getElementById('user-list');
        const mainChatHeader = document.getElementById('main-chat-header');
        const currentChatUserNameH2 = document.getElementById('current-chat-userName');
        const userStatusDiv = document.getElementById('user-status');
        const userStatusSpan = userStatusDiv.querySelector('.status-dot');
        const mainChatActions = document.getElementById('main-chat-actions');
        const typingIndicatorDiv = document.getElementById('typing-indicator');
        const blockUserButton = document.getElementById('blockUserButton');
        const deleteUserButton = document.getElementById('deleteUserButton'); // Updated ID
        const exportChatButton = document.getElementById('exportChatButton');
        const callNotificationsContainer = document.getElementById('call-notifications-container');
        const ringtoneAudio = document.getElementById('ringtone');
        const muteButton = document.getElementById('muteButton');
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');

        // --- State Variables ---
        let appState = 'LOGIN_BOT_INIT'; let tempEmail = ''; let tempPassword = ''; let selectedUserId = null;
        let currentUserList = {}; let typingTimeout = null; let isMuted = localStorage.getItem('adminMuted') === 'true';
        let globalListeners = { users: null, calls: null }; let currentAdminUser = null; let botMessageTimeout;
        let peerConnection = null; let localStream = null; let activeCallUserId = null;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let callSignalListeners = {};
        let userToSelectOnLoad = null; // For handling URL parameter

        // --- Hardcoded Credentials ---
        const ADMIN_EMAIL = "cnow20874@gmail.com"; const ADMIN_PASSWORD = "hi99wMJpgfHpQjZ";

        // --- Firebase Refs ---
        const rootRef = ref(db); const chatsRef = ref(db, 'chats'); const adminStatusRef = ref(db, 'adminStatus');

        // --- Initialization and Auth ---
        function initializeAppView() {
            // 1. Check for URL parameter *before* setting up auth persistence
            const urlParams = new URLSearchParams(window.location.search);
            userToSelectOnLoad = urlParams.get('user'); // Get potential userId
            if (userToSelectOnLoad) {
                 console.log("URL parameter found, will attempt to select user:", userToSelectOnLoad);
                 // Remove the parameter from the URL bar to avoid confusion after load
                 window.history.replaceState({}, document.title, window.location.pathname);
            }

            // 2. Set auth persistence and add auth listener
             setPersistence(auth, browserLocalPersistence).then(() => {
                 onAuthStateChanged(auth, handleAuthStateChange);
             }).catch((error) => {
                 console.error("Persistence error:", error);
                 onAuthStateChanged(auth, handleAuthStateChange); // Fallback
             });

            // 3. Setup UI Listeners
            sendButton.onclick = handleSendButtonClick; messageInput.onkeydown = handleInputKeydown; logoutButton.onclick = handleLogout; muteButton.onclick = toggleMute; blockUserButton.onclick = toggleBlockUser;
            deleteUserButton.onclick = deleteUser; // Changed from deleteChat
            exportChatButton.onclick = exportChat;
            updateMuteButtonUI(); requestNotificationPermission();
        }

        // Auth state change handler (mostly same, handles auto-select)
        function handleAuthStateChange(user) {
            clearTimeout(botMessageTimeout);
            if (user && user.email === ADMIN_EMAIL) {
                 console.log("Admin authenticated:", user.email); currentAdminUser = user;
                 if (!appState.startsWith('ADMIN_')) { displayBotMessage("Login Successful!", true); botMessageTimeout = setTimeout(() => { displayBotMessage("Connecting..."); botMessageTimeout = setTimeout(switchToAdminMode, 800); }, 500); }
                 else { switchToAdminMode(); } // Already in admin mode, ensure UI correct
            } else {
                 console.log("Admin not authenticated."); if (currentAdminUser) { setAdminOnlineStatus(false); } currentAdminUser = null;
                 if (appState.startsWith('ADMIN_')) { switchToLoginBotMode(); } else { switchToLoginBotMode(true); } // Handles initial load / failed login
            }
        }


        // --- UI Mode Switching (mostly same) ---
        function switchToLoginBotMode(showWelcome = false) { /* ... */
            console.log("Switching to Login Bot Mode"); appState = 'LOGIN_BOT_INIT'; cleanupAdminListeners(); hangUpCall(false); userToSelectOnLoad = null; // Clear auto-select target
            mainChatActions.classList.add('hidden'); userStatusDiv.classList.add('hidden'); currentChatUserNameH2.textContent = "Admin Login"; messagesDiv.innerHTML = ''; typingIndicatorDiv.textContent = ''; hideAllCallNotifications(); messageInput.type = "text"; messageInput.placeholder = "Type anything to start..."; messageInput.disabled = false; sendButton.disabled = false;
            blockUserButton.disabled = true; deleteUserButton.disabled = true; exportChatButton.disabled = true; blockUserButton.textContent = 'Block'; blockUserButton.classList.remove('unblock');
            if (showWelcome) { displayBotMessage("Welcome Admin! Send any message to start."); }
        }
        function switchToAdminMode() { /* ... */
            console.log("Switching to Admin Mode"); if (appState.startsWith('ADMIN_')) { /* Maybe refresh list if already admin */ if (!globalListeners.users) { loadUserListAndListeners(); } else { updateUserListUI(); } return; };
            appState = 'ADMIN_IDLE'; messagesDiv.innerHTML = ''; typingIndicatorDiv.textContent = '';
            mainChatActions.classList.remove('hidden'); userStatusDiv.classList.add('hidden');
            currentChatUserNameH2.textContent = "Select a User"; messageInput.placeholder = "Select a user..."; messageInput.type = 'text'; messageInput.disabled = true; sendButton.disabled = true;
            blockUserButton.disabled = true; deleteUserButton.disabled = true; exportChatButton.disabled = true;
            if (!globalListeners.users) { loadUserListAndListeners(); /* Attaches listeners which might trigger auto-select */ } else { updateUserListUI(); /* Might trigger auto-select if list updates */ }
            if (currentAdminUser) { adminEmailDisplay.textContent = currentAdminUser.email; }
            setAdminOnlineStatus(true); updateMuteButtonUI(); hideAllCallNotifications();
        }

        // --- Login Bot (SAME) ---
        function handleLoginBotInput() { /* ... */ }
        function verifyCredentials() { /* ... */ }

        // --- Core Event Handlers (SAME) ---
        function handleSendButtonClick() { /* ... */ }
        function handleInputKeydown(e) { /* ... */ }
        function handleLogout() { /* ... */ }

        // --- Message Display (SAME) ---
        function displayMessage(senderType, text, timestamp, msgId, seenByAdmin, clearPrevious) { /* ... */ }
        function displayBotMessage(text, clearPrevious = false) { /* ... */ }
        function scrollToBottom() { /* ... */ }

        // --- Admin Functionality ---

        async function setAdminOnlineStatus(isOnline) { /* ... (SAME) ... */ }

        // Load User List (Handles Auto-Select)
        function loadUserListAndListeners() {
             if (globalListeners.users) return; console.log("Loading users..."); currentUserList = {};
             const usersQuery = query(chatsRef, orderByChild('metadata/lastActive'));
             let initialLoadComplete = false; // Flag to prevent multiple auto-select attempts

             globalListeners.users = onValue(usersQuery, (snapshot) => {
                 const users = []; let userCount = 0; let foundUserToSelect = false;
                 snapshot.forEach((cs) => {
                     const uid = cs.key; const ud = cs.val();
                     if (ud?.metadata && uid !== 'adminStatus') {
                         userCount++; const name = ud.metadata.userName || `User ${uid.substring(0, 4)}`; const lastActive = ud.metadata.lastActive || 0; const isBlocked = ud.metadata.isBlocked || false; users.push({ userId: uid, userName: name, lastActive, isBlocked });
                         if (!currentUserList[uid]) { currentUserList[uid] = { userName: name, unreadCount: 0, listenersAttached: false, isBlocked, lastActive }; } else { currentUserList[uid].userName = name; currentUserList[uid].isBlocked = isBlocked; currentUserList[uid].lastActive = lastActive; }
                         if (!currentUserList[uid].listenersAttached) { attachUserSpecificListeners(uid); }
                         if (uid === userToSelectOnLoad) foundUserToSelect = true; // Check if our target user is in the list
                     }
                 });
                 users.sort((a, b) => b.lastActive - a.lastActive);
                 updateUserListUI(users);
                 userCountDisplay.textContent = userCount;

                 // --- Attempt Auto-Selection AFTER initial list is processed ---
                 if (userToSelectOnLoad && foundUserToSelect && !initialLoadComplete) {
                     console.log("Attempting to auto-select user from URL:", userToSelectOnLoad);
                     selectUserChat(userToSelectOnLoad);
                     userToSelectOnLoad = null; // Clear target after successful selection
                 }
                 initialLoadComplete = true; // Mark initial load done

             }, (error) => { console.error("User list error:", error); });

             // Global listener for calls (SAME)
             globalListeners.calls = onChildChanged(chatsRef, (snapshot) => { /* ... */
                const uid = snapshot.key; const changedData = snapshot.val(); if (uid === 'adminStatus') return;
                if (changedData?.call?.state === 'ringing' && changedData.call.initiator === 'user') { const name = changedData.metadata?.userName || currentUserList[uid]?.userName || 'Unknown'; handleIncomingCall(uid, name, changedData.call); }
                if (changedData?.metadata && currentUserList[uid]) { const isBlocked = changedData.metadata.isBlocked || false; if (currentUserList[uid].isBlocked !== isBlocked) { currentUserList[uid].isBlocked = isBlocked; const li = document.getElementById(`user-${uid}`); if (li) li.style.opacity = isBlocked ? 0.6 : 1; } }
             });
        }

        // Update User List UI (SAME)
        function updateUserListUI(users = null) { /* ... */
            if (!users) { users = Object.keys(currentUserList).map(uid => ({ userId: uid, ...currentUserList[uid] })).filter(u => u.userName).sort((a, b) => (b.lastActive || 0) - (a.lastActive || 0)); }
            userListUL.innerHTML = ''; users.forEach(user => { displayUserInList(user.userId, user.userName, user.isBlocked); updateUnreadIndicator(user.userId, currentUserList[user.userId]?.unreadCount || 0); });
            if (selectedUserId && document.getElementById(`user-${selectedUserId}`)) { document.getElementById(`user-${selectedUserId}`).classList.add('active'); }
            else if (selectedUserId) { /* Selected user removed */ resetChatView(); }
            else if (userToSelectOnLoad && document.getElementById(`user-${userToSelectOnLoad}`)) {
                 // Handle case where list updates *after* URL check but *before* selection
                 console.log("Auto-selecting user after list update:", userToSelectOnLoad);
                 selectUserChat(userToSelectOnLoad);
                 userToSelectOnLoad = null;
            }
        }


        // Display User in List (SAME)
        function displayUserInList(userId, userName, isBlocked = false) { /* ... */ }

        // Attach User Listeners (Add notification trigger)
        function attachUserSpecificListeners(userId) {
            if (!currentUserList[userId] || currentUserList[userId].listenersAttached) return;
            const userCache = currentUserList[userId];
            const userMessagesRef = ref(db, `chats/${userId}/messages`);
            const userStatusRef = ref(db, `chats/${userId}/status`);
            const userCallRef = ref(db, `chats/${userId}/call`);
            // Listen for *all* new messages to handle notifications correctly
            userCache.messageListener = onChildAdded(userMessagesRef, (snapshot) => {
                 const msg = snapshot.val(); const msgId = snapshot.key;
                 if (!msg) return; // Skip if message data is invalid

                 const isNewUnseen = msg.sender === 'user' && !msg.seenByAdmin;

                 if (userId === selectedUserId) {
                      // If chat is open, display and mark seen (if needed)
                      if (!document.getElementById(`msg-${msgId}`)){ // Prevent duplicate display
                         displayMessage(msg.sender === 'admin' ? 'sent' : 'received', msg.text, msg.timestamp, msgId, msg.seenByAdmin);
                      }
                      if (isNewUnseen) {
                         markMessageAsSeen(userId, msgId);
                      }
                 } else if (isNewUnseen) {
                      // If chat is closed and message is new/unseen, increment count and notify
                      // Check timestamp roughly to avoid counting very old messages on initial load? Optional.
                      // const messageTime = msg.timestamp || 0;
                      // const fiveMinutesAgo = Date.now() - 5 * 60 * 1000;
                      // if (messageTime > fiveMinutesAgo) { // Only count/notify for recent messages?

                         userCache.unreadCount = (userCache.unreadCount || 0) + 1;
                         updateUnreadIndicator(userId, userCache.unreadCount);
                         if (!isMuted) {
                             showNotification(`New message from ${userCache.userName}`);
                             // Play sound?
                         }
                     // }
                 }
            });
            // Status Listener (SAME)
            userCache.statusListener = onValue(userStatusRef, (s) => { userCache.status = s.val(); if (userId === selectedUserId) { updateUserStatusUI(userCache.status); } });
            // Call Listener (SAME)
            userCache.callListener = onValue(userCallRef, (s) => { /* ... updates call UI, handles external end ... */
                 const callState = s.val(); userCache.callState = callState; updateAdminCallUI(callState, userId, userCache.userName); if (activeCallUserId === userId && (!callState || callState.state === 'ended' || callState.state === 'idle')) { hangUpCall(false); }
            });
            userCache.listenersAttached = true;
        }


        // Cleanup Listeners (SAME)
        function cleanupAdminListeners() { /* ... */ }
        function detachUserSpecificListeners(userId) { /* ... */
            // *** Important: Ensure off() uses the correct ref used in onChildAdded ***
             const uc = currentUserList[userId]; if (!uc || !uc.listenersAttached) return;
             const msgRef = ref(db, `chats/${userId}/messages`); /* Ref for child_added */
             const statusRef = ref(db, `chats/${userId}/status`); const callRef = ref(db, `chats/${userId}/call`);
             if (uc.messageListener) off(msgRef, 'child_added', uc.messageListener); // Use the base ref
             if (uc.statusListener) off(statusRef, 'value', uc.statusListener); if (uc.callListener) off(callRef, 'value', uc.callListener);
             uc.messageListener = uc.statusListener = uc.callListener = null; uc.listenersAttached = false; console.log(`Listeners detached for ${userId}`);
        }

        // Reset Chat View (SAME)
        function resetChatView() { /* ... */ }
        // Select User Chat (SAME)
        function selectUserChat(userId) { /* ... */
             if (!currentUserList[userId] || !appState.startsWith('ADMIN_')) return; if (activeCallUserId && activeCallUserId !== userId) { alert(`End call with ${currentUserList[activeCallUserId]?.userName || 'user'} first.`); return; }
             if (selectedUserId) { const prevLi = document.getElementById(`user-${selectedUserId}`); if (prevLi) prevLi.classList.remove('active'); }
             selectedUserId = userId; appState = 'ADMIN_CHAT_SELECTED'; const currentLi = document.getElementById(`user-${selectedUserId}`); if (currentLi) currentLi.classList.add('active');
             if (currentUserList[userId]) { currentUserList[userId].unreadCount = 0; updateUnreadIndicator(userId, 0); }
             loadChatForSelectedUser(userId); messageInput.disabled = false; sendButton.disabled = false; blockUserButton.disabled = false; deleteUserButton.disabled = false; exportChatButton.disabled = false; messageInput.focus(); messageInput.placeholder = `Reply to ${currentUserList[userId]?.userName || 'User'}...`; updateBlockButtonUI(userId); updateAdminCallUI(currentUserList[userId]?.callState, userId, currentUserList[userId]?.userName);
        }
        // Load Chat History (SAME)
        async function loadChatForSelectedUser(userId) { /* ... */ }
        // Update Status UI (SAME)
        function updateUserStatusUI(status) { /* ... */ }
        // Send Admin Message (SAME)
        function sendAdminMessageToUser() { /* ... */ }
        // Handle Admin Typing (SAME)
        function handleAdminTyping() { /* ... */ }
        // Mark Message Seen (SAME)
        function markMessageAsSeen(userId, msgId) { /* ... */ }
        // Mark Multiple Messages Seen (SAME)
        function markMultipleMessagesAsSeen(userId, msgIds) { /* ... */ }
        // Update Unread Indicator (SAME)
        function updateUnreadIndicator(userId, count) { /* ... */ }

        // --- Chat Actions Implementation ---

        // Toggle Block User (SAME)
        function toggleBlockUser() { /* ... */ }
        // Update Block Button UI (SAME)
        function updateBlockButtonUI(userId) { /* ... */ }

        // Delete User (Replaces Delete Chat)
        function deleteUser() {
            if (!selectedUserId || appState !== 'ADMIN_CHAT_SELECTED') return;

            const userIdToDelete = selectedUserId; // Capture ID in case selection changes during async
            const userName = currentUserList[userIdToDelete]?.userName || 'this user';

            if (confirm(`DELETE USER: ${userName}?\n\nThis will permanently remove the user and all their chat history. This cannot be undone.`)) {
                 deleteUserButton.disabled = true; // Disable while deleting
                 blockUserButton.disabled = true;
                 exportChatButton.disabled = true;

                 const userChatRef = ref(db, `chats/${userIdToDelete}`);
                 remove(userChatRef)
                    .then(() => {
                         console.log(`User ${userIdToDelete} deleted successfully.`);
                         alert(`User ${userName} has been deleted.`);

                         // Remove user from local cache and UI
                         delete currentUserList[userIdToDelete];
                         const li = document.getElementById(`user-${userIdToDelete}`);
                         if (li) li.remove();
                         userCountDisplay.textContent = Object.keys(currentUserList).length; // Update count


                         // Reset view to idle state
                         resetChatView();

                     })
                     .catch(error => {
                          console.error(`Error deleting user ${userIdToDelete}:`, error);
                          alert(`Failed to delete user ${userName}.`);
                          // Re-enable buttons if the selected user still technically exists
                           if(selectedUserId === userIdToDelete) {
                               deleteUserButton.disabled = false;
                               blockUserButton.disabled = false;
                               exportChatButton.disabled = false;
                           }
                     });
                    // Note: No finally block needed here as the view is reset on success.
            }
        }

        // Export Chat (SAME)
        async function exportChat() { /* ... */ }


        // --- WebRTC Call Handling (SAME as previous Admin version) ---
        async function createAdminPeerConnection(callUserId) { /* ... */ }
        function handleIncomingCall(userId, userName, callData) { /* ... (Ensure showNotification is called here if !isMuted) ... */
            if (!appState.startsWith('ADMIN_') || activeCallUserId) { /* ... busy check ... */ return; }
            if (document.getElementById(`call-alert-${userId}`)) return; console.log(`Incoming call from ${userName} (${userId})`);
            const alertDiv = document.createElement('div'); alertDiv.id = `call-alert-${userId}`; alertDiv.classList.add('call-alert', 'incoming');
            alertDiv.innerHTML = `<span>Incoming: <strong>${userName}</strong></span><div class="button-group"><button class="join">Join</button><button class="reject">Reject</button></div>`; callNotificationsContainer.appendChild(alertDiv);
            alertDiv.querySelector('.join').onclick = () => joinIncomingCall(userId, userName, callData.offer, alertDiv); alertDiv.querySelector('.reject').onclick = () => rejectIncomingCall(userId, alertDiv);
            if (!isMuted) { ringtoneAudio.play().catch(e => {}); showNotification(`Incoming call from ${userName}!`); } else { showNotification(`Call from ${userName} (Muted)`); }
        }
        async function joinIncomingCall(userId, userName, offerData, alertElement) { /* ... */ }
        function listenForUserIceCandidates(userId) { /* ... */ }
        function cleanupUserIceListener(userId) { /* ... */ }
        function rejectIncomingCall(userId, alertElement) { /* ... */ }
        function hangUpCall(signalFirebase = true) { /* ... */ }
        function updateAdminCallUI(callState, userId, userName) { /* ... */ }
        function showActiveCallUI(userId, userName) { /* ... */ }
        function hideActiveCallUI(userId) { /* ... */ }
        function hideAllCallNotifications() { /* ... */ }

        // --- Mute and Notifications ---
        function toggleMute() { /* ... */ }
        function updateMuteButtonUI() { /* ... */ }
        function requestNotificationPermission() { /* ... */ }
        function showNotification(message) { // Standard browser notification
            if (isMuted) return; // Don't show if muted
            requestNotificationPermission(); // Check/request permission
            // Check if permission granted and tab is hidden/inactive
            if ('Notification' in window && Notification.permission === 'granted' && document.hidden) {
                // Use a generic title
                const notification = new Notification('Admin Panel Alert', {
                     body: message,
                     // icon: 'path/to/icon.png' // Optional: Add an icon URL
                     tag: 'admin-chat-alert' // Optional: Use a tag to replace previous notifications
                 });
                // Optional: Close notification automatically after a few seconds
                // setTimeout(notification.close.bind(notification), 5000);
            } else if ('Notification' in window && Notification.permission === 'granted' && !document.hidden) {
                 console.log("Notification suppressed: Tab is active.");
            } else if ('Notification' in window && Notification.permission === 'denied') {
                 console.warn("Notification permission denied by user.");
            } else if (!('Notification' in window)) {
                 console.warn("Browser does not support Notifications.");
            }
        }


        // --- Conceptual Placeholder for Required User Panel Change ---
        // In User.html's sendMessage function, add this check:
        /*
        function sendMessage(msgText) {
            // ... (existing message sending code) ...

            push(messagesRef, messageData)
                .then(() => {
                    // ... (existing success code) ...

                    // --- CHECK ADMIN STATUS FOR EMAIL NOTIFICATION ---
                    const adminOnlineStatusRef = ref(db, 'adminStatus/online');
                    get(adminOnlineStatusRef).then(snapshot => {
                        if (snapshot.exists() && snapshot.val() === false) {
                            console.log("Admin is offline. ** SIMULATING EMAIL TRIGGER **");
                            // CONSTRUCT UNIQUE URL
                            const currentAdminPanelUrl = "https://YOUR_ADMIN_PANEL_URL/Admin.html"; // Replace with actual URL
                            const uniqueUrl = `${currentAdminPanelUrl}?user=${userId}`;
                            console.log(`Email would be sent to ${ADMIN_EMAIL} for user ${userName} (${userId}) with link: ${uniqueUrl}`);

                            // **** FIREBASE FUNCTION NEEDED HERE ****
                            // In a real app, you'd trigger a Firebase Function here,
                            // passing userId, userName, messageText, and uniqueUrl.
                            // The Function would then use SendGrid/Mailgun etc. to send the email.
                            // Example Function Trigger Data: { userId, userName, messageText, uniqueUrl, adminEmail: ADMIN_EMAIL }
                        }
                    }).catch(error => {
                         console.error("Error checking admin status:", error);
                    });
                    // --- END EMAIL CHECK ---

                })
                .catch(error => { // ... existing error handling ... });
        }
        */

        // --- Run App ---
        initializeAppView();

    </script>

</body>
</html>