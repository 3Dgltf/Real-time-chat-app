<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <style>
        /* --- Base Styles (from user panel UI) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        html, body {
            height: 100%; /* Ensure body takes full height */
            overflow: hidden; /* Prevent double scrollbars */
        }
        body {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            padding: 0; /* Remove body padding for full screen container */
        }

        /* --- Main Container (Looks like user chat initially) --- */
        .admin-main-container {
            width: 100%;
            height: 100vh;
            display: flex;
            background-color: rgba(0, 0, 0, 0.1); /* Slightly darker background */
            /* Removed backdrop-filter for potentially better performance on complex layout */
        }

        /* --- Sidebar (Hidden initially, appears after login) --- */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.05); /* Transparent sidebar */
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            transition: width 0.3s ease; /* Add transition */
            flex-shrink: 0; /* Prevent sidebar from shrinking */
        }
         .sidebar.hidden {
             width: 0; /* Collapse width when hidden */
             padding: 0;
             border-right: none;
         }

        .admin-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
             white-space: nowrap; /* Prevent wrap during transition */
             overflow: hidden;
        }
        .admin-header h3 { margin-bottom: 10px; font-size: 1.2em; color: #fff;}
        #admin-profile { font-size: 0.85em; margin-bottom: 10px; word-break: break-all; color: #eee; }
        #admin-profile strong { color: #fff; }
        .sidebar-actions button { width: 100%; margin-bottom: 8px; font-size: 0.9em; }
        #logoutButton { background-color: #ff4f81; border: 1px solid rgba(255,255,255,0.3); }
        #logoutButton:hover { background-color: #e03060; }
        #muteButton { background-color: #ffd700; color: #333; border: 1px solid rgba(255,255,255,0.3); }
        #muteButton:hover { background-color: #e0a800;}
        #muteButton.muted { background-color: #ff8c00; color: white; }

        .user-list-header {
             padding: 10px 15px;
             font-weight: bold;
             color: #eee;
             border-bottom: 1px solid rgba(255, 255, 255, 0.2);
             font-size: 0.9em;
             background-color: rgba(255, 255, 255, 0.1);
             white-space: nowrap; overflow: hidden;
        }
        .user-list-container {
             flex-grow: 1;
             overflow-y: auto;
             background-color: transparent; /* Transparent list bg */
             scrollbar-width: thin;
             scrollbar-color: rgba(255,255,255,0.3) transparent;
        }
         .user-list-container::-webkit-scrollbar { width: 6px; }
         .user-list-container::-webkit-scrollbar-track { background: transparent; }
         .user-list-container::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.3); border-radius: 3px;}

        #user-list { list-style: none; padding: 0; margin: 0; }
        #user-list li {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            color: #eee;
            white-space: nowrap; overflow: hidden;
        }
        #user-list li:hover { background-color: rgba(255, 255, 255, 0.1); }
        #user-list li.active { background-color: #2575fc; color: white; font-weight: bold; }
        #user-list li.active:hover { background-color: #1a5fce; }
        #user-list li .user-name { overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 10px; }
        #user-list li .unread-indicator {
            min-width: 18px; height: 18px; background-color: #ff4f81; border-radius: 50%;
            color: white; font-size: 0.7em; font-weight: bold; text-align: center;
            line-height: 18px; padding: 0 4px; flex-shrink: 0; opacity: 0;
            transform: scale(0.5); transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #user-list li .unread-indicator.visible { opacity: 1; transform: scale(1); }

        /* --- Chat Area (Takes remaining space) --- */
        .chat-area-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Important */
             /* Use the user panel gradient */
             background: linear-gradient(to right, #6a11cb, #2575fc);
        }

        /* Chat Header - Modified for Admin */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background-color: rgba(0, 0, 0, 0.2); /* Darker translucent header */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
            color: #fff;
            transition: background-color 0.3s ease;
        }
        .chat-header.login-mode {
             background-color: transparent; /* Transparent header during login */
             border-bottom: none;
        }
        .chat-header-left { display: flex; flex-direction: column; }
        .chat-header-left h2 { margin: 0; font-size: 1.1em; color: #fff; }
        #user-status { font-size: 0.8em; color: #ddd; margin-top: 2px; }
        #user-status .status-dot {
            width: 9px; height: 9px; border-radius: 50%; margin-right: 4px;
            display: inline-block; vertical-align: middle; background-color: #aaa;
            transition: background-color 0.3s ease;
        }
        #user-status .status-dot.online { background-color: #33ff33; }
        #user-status .status-dot.offline { background-color: #aaa; }

        .chat-actions button {
            margin-left: 8px; padding: 6px 10px; font-size: 0.8em;
            background-color: rgba(255,255,255, 0.2); color: #fff; border: 1px solid rgba(255,255,255,0.3);
        }
        .chat-actions button:hover { background-color: rgba(255,255,255, 0.3); }
        .chat-actions button:disabled { background-color: rgba(255,255,255, 0.1); color: #aaa; cursor: not-allowed; }
        #blockUserButton { background-color: #ffd700; color: #333;}
        #blockUserButton.unblock { background-color: #33ff33; color: #000;}
        #deleteChatButton { background-color: #ff4f81; color: white; }
        #exportChatButton { background-color: #00c6ff; color: #000; }

        /* Messages Area */
        .messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }
         .messages-container::-webkit-scrollbar { width: 6px; }
         .messages-container::-webkit-scrollbar-track { background: transparent; }
         .messages-container::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.3); border-radius: 3px;}

        /* Message Styles (Combine User/Admin/Bot) */
        .message-wrapper {
            display: flex;
            margin-bottom: 10px;
            max-width: 85%;
        }
        .message-wrapper.sent { /* Admin sending */
            align-self: flex-end;
            justify-content: flex-end;
        }
        .message-wrapper.received { /* User sending to admin */
            align-self: flex-start;
        }
        .message-wrapper.bot { /* Login Bot messages */
             align-self: flex-start;
        }

        .message-wrapper p {
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
            line-height: 1.4;
            color: #000; /* Default text color */
        }
        .message-wrapper.sent p { /* Admin sent */
            background-color: #00c6ff; /* Admin uses user's 'sent' color */
            border-bottom-right-radius: 5px;
        }
        .message-wrapper.received p { /* User received */
            background-color: #ffd700; /* Admin uses user's 'received' color */
            border-bottom-left-radius: 5px;
        }
        .message-wrapper.bot p { /* Bot messages */
             background-color: rgba(255, 255, 255, 0.8); /* Whiteish bot bubble */
             color: #333;
             border-bottom-left-radius: 5px;
        }

        .message-wrapper .timestamp {
            font-size: 0.7em; color: rgba(255, 255, 255, 0.6); margin-top: 4px; display: block;
        }
        .message-wrapper.sent .timestamp { text-align: right; }
        .message-wrapper.received .timestamp, .message-wrapper.bot .timestamp { text-align: left; }

        /* Seen Checkmark (Only for received 'user' messages) */
         .message-wrapper.received .timestamp::after {
            content: ''; display: inline-block; width: 12px; height: 12px; margin-left: 5px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 15.1"><path fill="%23aaccaa" d="M15.6 3.4l-1.1-1.1-8.9 8.9L1.8 7.4l-1.1 1.1 4.8 4.8 10.1-10z"/></svg>'); /* Single light green tick */
            background-repeat: no-repeat; background-size: contain; vertical-align: bottom;
        }
        .message-wrapper.received.seen .timestamp::after {
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 15.1"><path fill="%2333ff33" d="M17.6 3.4L16.5 2.3C13.1-1.1 7.1 2.1 4.7 4.5l-1.9 1.9-1.1 1.1 4.8 4.8 1.1-1.1 1.9-1.9c2.4-2.4 8.4-5.6 10.1-3.9zm-4.8 4.8l-1.1 1.1-4.8-4.8L8 3.4l1.1-1.1 4.8 4.8z"/></svg>'); /* Double bright green tick */
        }


        /* Input Area */
        .input-area {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background-color: rgba(0, 0, 0, 0.2); /* Darker translucent input area */
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }
        .input-area input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            outline: none;
            margin-bottom: 0; /* Override */
        }
        .input-area input[type="text"]::placeholder { color: #888; }
        .input-area input[type="text"]:disabled { background-color: #ccc; }

        .input-area button {
            padding: 12px 18px;
            border-radius: 10px;
            background-color: #00ffcc;
            color: #000;
            font-weight: bold;
            transition: background-color 0.2s ease;
            border: none; /* Override */
            /* Standard send button style */
        }
        .input-area button:hover { background-color: #00ccaa; }
        .input-area button:disabled { background-color: #aaa; cursor: not-allowed; }

        #typing-indicator {
            min-height: 18px; font-style: italic; color: rgba(255, 255, 255, 0.7);
            font-size: 0.85em; padding: 5px 20px; /* Padding to align with messages */
            background-color: transparent; /* Typing indicator bg transparent */
            flex-shrink: 0;
        }

        /* Call Notifications */
        #call-notifications-container {
             position: absolute;
             top: 10px;
             right: 10px;
             z-index: 100;
             display: flex;
             flex-direction: column;
             gap: 10px;
        }
        .call-alert {
            padding: 12px 15px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .call-alert.incoming { background-color: #28a745; } /* Green incoming */
        .call-alert.active { background-color: #007bff; } /* Blue active */
        .call-alert button {
             margin-left: 10px; background-color: rgba(255,255,255,0.8); color: #333;
             padding: 5px 10px; font-size: 0.85em; border: none;
        }
        .call-alert button.reject, .call-alert button.end { background-color: #ff4f81; color: white; }

        /* Utility */
        .hidden { display: none !important; }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
             .admin-main-container { flex-direction: column; height: auto; min-height: 100vh; }
             .sidebar {
                 width: 100% !important; /* Full width when stacked */
                 height: auto; /* Auto height */
                 max-height: 40vh; /* Limit height */
                 border-right: none;
                 border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                 flex-shrink: 0;
                 transition: max-height 0.3s ease; /* Transition height */
             }
             .sidebar.hidden { max-height: 0; border: none; }
             .chat-area-wrapper { min-height: 60vh; } /* Ensure chat takes remaining space */
             .input-area { padding: 10px 15px; }
             .message-wrapper { max-width: 90%; }
             #call-notifications-container { top: 60px; /* Adjust below potential header */}
        }

    </style>
</head>
<body>

    <!-- Main Container -->
    <div class="admin-main-container">

        <!-- Sidebar (Hidden Initially) -->
        <aside class="sidebar hidden" id="admin-sidebar">
            <div class="admin-header">
                <h3>Admin Panel</h3>
                <div id="admin-profile">Logged in as: <strong id="admin-email-display"></strong></div>
                <div class="sidebar-actions">
                    <button id="muteButton">Mute Alerts</button>
                    <button id="logoutButton">Logout</button>
                </div>
            </div>
            <div class="user-list-header">Users</div>
            <div class="user-list-container">
                <ul id="user-list"></ul>
            </div>
        </aside>

        <!-- Chat Area Wrapper -->
        <div class="chat-area-wrapper">
            <!-- Header (Content changes based on mode) -->
            <div class="chat-header login-mode" id="main-chat-header">
                <div class="chat-header-left">
                     <h2 id="current-chat-userName">Admin Login</h2>
                     <div id="user-status" class="hidden">User: <span class="status-dot offline" title="Offline"></span></div>
                </div>
                <div class="chat-header-right chat-actions hidden" id="main-chat-actions">
                     <button id="blockUserButton" disabled>Block</button>
                     <button id="deleteChatButton" disabled>Delete Chat</button>
                     <button id="exportChatButton" disabled>Export</button>
                </div>
            </div>

             <!-- Typing Indicator -->
             <div id="typing-indicator"></div>

             <!-- Messages -->
            <div class="messages-container" id="messages">
                <!-- Login bot messages appear here first -->
                <!-- User chat messages appear here after login -->
            </div>

            <!-- Input -->
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off">
                <button id="sendButton">Send</button>
            </div>
        </div>
    </div>

     <!-- Call Notifications (Overlay) -->
     <div id="call-notifications-container">
         <!-- Call alerts will be added here by JS -->
     </div>


    <!-- Audio element for ringtone -->
    <audio id="ringtone" src="ringtone.mp3" preload="auto"></audio> <!-- UPDATE src PATH -->

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK Imports (v9 modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, onChildAdded, onChildChanged, serverTimestamp, query, orderByChild, limitToLast, update, remove, off, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA5mBW5mXff46acu01BbPmZh8LGGXV42v8",
            authDomain: "chat-app-ddecb.firebaseapp.com",
            databaseURL: "https://chat-app-ddecb-default-rtdb.firebaseio.com",
            projectId: "chat-app-ddecb",
            storageBucket: "chat-app-ddecb.firebasestorage.app",
            messagingSenderId: "534760202357",
            appId: "1:534760202357:web:da7d90561af1c4220a183c",
            measurementId: "G-MCSSLKG71W"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- DOM Elements ---
        const adminSidebar = document.getElementById('admin-sidebar');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const adminEmailDisplay = document.getElementById('admin-email-display');
        const logoutButton = document.getElementById('logoutButton');
        const userListUL = document.getElementById('user-list');
        const mainChatHeader = document.getElementById('main-chat-header');
        const currentChatUserNameH2 = document.getElementById('current-chat-userName');
        const userStatusDiv = document.getElementById('user-status');
        const userStatusSpan = userStatusDiv.querySelector('.status-dot');
        const mainChatActions = document.getElementById('main-chat-actions');
        const typingIndicatorDiv = document.getElementById('typing-indicator');
        const blockUserButton = document.getElementById('blockUserButton');
        const deleteChatButton = document.getElementById('deleteChatButton');
        const exportChatButton = document.getElementById('exportChatButton');
        const callNotificationsContainer = document.getElementById('call-notifications-container');
        const ringtoneAudio = document.getElementById('ringtone');
        const muteButton = document.getElementById('muteButton');

        // --- State Variables ---
        let loginState = 'AWAITING_INITIATION'; // States: AWAITING_INITIATION, AWAITING_EMAIL, AWAITING_PASSWORD, VERIFYING, LOGGED_IN, LOGIN_FAILED
        let tempEmail = '';
        let tempPassword = '';
        let selectedUserId = null;
        let currentUserList = {}; // Cache for user data and listeners
        let typingTimeout = null;
        let isMuted = localStorage.getItem('adminMuted') === 'true';
        let globalListenersAttached = false;
        let currentAdminUser = null; // Store the logged-in admin user object

        // --- Hardcoded Admin Credentials (as requested) ---
        const ADMIN_EMAIL = "cnow20874@gmail.com";
        const ADMIN_PASSWORD = "hi99wMJpgfHpQjZ";

        // --- Firebase Refs ---
        const chatsRef = ref(db, 'chats');
        const adminStatusRef = ref(db, 'adminStatus');

        // --- Initialization and Auth Handling ---
        // Set persistence to local storage
        setPersistence(auth, browserLocalPersistence)
          .then(() => {
            // Now listen for auth state changes
            onAuthStateChanged(auth, (user) => {
                if (user && user.email === ADMIN_EMAIL) {
                    // User is signed in and is the correct admin
                    currentAdminUser = user;
                    console.log("Admin already authenticated:", user.email);
                    if (loginState !== 'LOGGED_IN') {
                         activateAdminMode(true); // Activate admin mode directly, skip bot chat
                    }
                } else {
                    // User is signed out or not the correct admin
                    currentAdminUser = null;
                    console.log("Admin not authenticated or incorrect user.");
                    if (loginState === 'LOGGED_IN') {
                        deactivateAdminMode(); // Go back to login mode if was logged in
                    }
                    if (loginState !== 'AWAITING_INITIATION') { // Avoid double welcome if already there
                         startLoginBotConversation();
                    }
                }
            });
          })
          .catch((error) => {
            console.error("Error setting auth persistence: ", error);
            // Fallback or error handling needed here
          });


        function startLoginBotConversation() {
            loginState = 'AWAITING_INITIATION';
            messagesDiv.innerHTML = ''; // Clear previous messages
            displayMessage('bot', "Welcome Admin! Send any message to start the login process.");
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = "Type anything to start...";
            tempEmail = '';
            tempPassword = '';
        }

        // --- Login Bot Logic ---
        function handleLoginInput() {
            const inputText = messageInput.value.trim();
            if (!inputText) return;

            // Display admin's message immediately
            displayMessage('sent', inputText); // Display admin's input as 'sent'
            messageInput.value = '';
            messageInput.disabled = true; // Disable input while bot 'thinks'
            sendButton.disabled = true;

            // Process based on state
            setTimeout(() => { // Simulate bot thinking time
                switch (loginState) {
                    case 'AWAITING_INITIATION':
                        loginState = 'AWAITING_EMAIL';
                        displayMessage('bot', "Provide Email:");
                        messageInput.placeholder = "Enter your admin email...";
                        break;
                    case 'AWAITING_EMAIL':
                        tempEmail = inputText;
                        // Basic email format check (optional but good)
                        if (!/\S+@\S+\.\S+/.test(tempEmail)) {
                             displayMessage('bot', "Invalid email format. Please provide a valid email:");
                             loginState = 'AWAITING_EMAIL'; // Stay in this state
                             messageInput.placeholder = "Enter your admin email...";
                        } else {
                             loginState = 'AWAITING_PASSWORD';
                             displayMessage('bot', "Provide Password:");
                             messageInput.type = "password"; // Mask password input
                             messageInput.placeholder = "Enter your admin password...";
                        }
                        break;
                    case 'AWAITING_PASSWORD':
                        tempPassword = inputText;
                        loginState = 'VERIFYING';
                        displayMessage('bot', "Verifying credentials...");
                        messageInput.type = "text"; // Change back from password
                        messageInput.placeholder = "Verifying...";
                        verifyCredentials();
                        break;
                    case 'LOGIN_FAILED': // Allow retry after failure
                         loginState = 'AWAITING_EMAIL';
                         displayMessage('bot', "Provide Email:");
                         messageInput.placeholder = "Enter your admin email...";
                         break;
                    // Ignore input if already LOGGED_IN or VERIFYING
                    case 'LOGGED_IN':
                    case 'VERIFYING':
                         console.warn("Input ignored during state:", loginState);
                         break;
                }
                 // Re-enable input unless verifying or logged in
                 if (loginState !== 'VERIFYING' && loginState !== 'LOGGED_IN') {
                      messageInput.disabled = false;
                      sendButton.disabled = false;
                      messageInput.focus();
                 }
            }, 500); // 0.5 second delay
        }

        function verifyCredentials() {
            if (tempEmail === ADMIN_EMAIL && tempPassword === ADMIN_PASSWORD) {
                // Credentials match the hardcoded ones, now try Firebase sign-in
                signInWithEmailAndPassword(auth, tempEmail, tempPassword)
                    .then((userCredential) => {
                        // Sign in successful! onAuthStateChanged will handle activating admin mode.
                        console.log("Firebase Sign-in successful after bot verification.");
                        loginState = 'VERIFYING'; // Keep state until onAuthStateChanged confirms
                        displayMessage('bot', "Admin Login Successful!");
                        displayMessage('bot', "Connecting to User Panel...");
                        // Let onAuthStateChanged trigger activateAdminMode
                    })
                    .catch((error) => {
                        // Firebase sign-in failed even if hardcoded credentials matched
                        // (e.g., user disabled, network error)
                        console.error("Firebase Sign-in Error:", error);
                        displayMessage('bot', `Login failed: ${error.message}. Please try again.`);
                        loginState = 'LOGIN_FAILED';
                        messageInput.disabled = false;
                        sendButton.disabled = false;
                        messageInput.placeholder = "Type email again to retry...";
                    });

            } else {
                // Hardcoded credentials didn't match
                displayMessage('bot', "Invalid credentials. Please try again.");
                loginState = 'LOGIN_FAILED';
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.placeholder = "Type email again to retry...";
            }
        }


        // --- Admin Mode Activation/Deactivation ---
        function activateAdminMode(isAutoLogin = false) {
            console.log("Activating Admin Mode...");
            loginState = 'LOGGED_IN';
            messagesDiv.innerHTML = ''; // Clear login chat
            messageInput.placeholder = "Type your reply...";
            messageInput.disabled = true; // Keep disabled until user selected
            sendButton.disabled = true;
            messageInput.type = "text";

            // Show Admin UI elements
            adminSidebar.classList.remove('hidden');
            mainChatHeader.classList.remove('login-mode');
            userStatusDiv.classList.remove('hidden');
            mainChatActions.classList.remove('hidden');

            // Setup Admin Panel (Load users, attach listeners)
            if(currentAdminUser) {
                 adminEmailDisplay.textContent = currentAdminUser.email;
            }
            loadUserListAndListeners(); // Load users and attach global listeners
            updateMuteButtonUI();
            setAdminOnlineStatus(true);

            // Update header title
            currentChatUserNameH2.textContent = "Select a User"; // Initial state after login
        }

         function deactivateAdminMode() {
             console.log("Deactivating Admin Mode, returning to login.");
             loginState = 'AWAITING_INITIATION'; // Reset state
             setAdminOnlineStatus(false); // Set offline
             cleanupAdminListeners(); // Detach all listeners

             // Hide Admin UI elements
             adminSidebar.classList.add('hidden');
             mainChatHeader.classList.add('login-mode');
             userStatusDiv.classList.add('hidden');
             mainChatActions.classList.add('hidden');
             clearChatView(); // Clear selected chat specific UI

             // Reset header title
             currentChatUserNameH2.textContent = "Admin Login";
             adminEmailDisplay.textContent = ''; // Clear logged in email

             // Start the bot conversation again
             startLoginBotConversation();
         }


        function handleLogout() {
             signOut(auth).catch((error) => {
                 console.error("Sign Out Error:", error);
                 alert("Error signing out.");
             });
             // onAuthStateChanged will handle UI changes (calling deactivateAdminMode)
        }

         function setAdminOnlineStatus(isOnline) {
             // Now uses currentAdminUser state variable
             if (currentAdminUser) {
                 set(ref(db, 'adminStatus/online'), isOnline);
                 set(ref(db, 'adminStatus/lastSeen'), serverTimestamp());
                 // Set offline on disconnect
                 onDisconnect(ref(db, 'adminStatus/online')).set(false);
                 onDisconnect(ref(db, 'adminStatus/lastSeen')).set(serverTimestamp());
             } else if (!isOnline) {
                  // If logging out and currentAdminUser is already null, still try to set offline
                  set(ref(db, 'adminStatus/online'), false);
                  set(ref(db, 'adminStatus/lastSeen'), serverTimestamp());
             }
        }

        // --- DISPLAY MESSAGES (Unified for Bot/Admin/User) ---
        function displayMessage(sender, text, timestamp, msgId = null, seenByAdmin = false) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-wrapper', sender); // sender = 'bot', 'sent' (admin), 'received' (user)
            if (msgId) wrapper.id = `msg-${msgId}`;

            const p = document.createElement('p');
            p.textContent = text; // Use textContent for security

            const timeSpan = document.createElement('span');
            timeSpan.classList.add('timestamp');
            // Show timestamp only for user/admin messages, not bot
            if (sender === 'sent' || sender === 'received') {
                 timeSpan.textContent = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                  // Add seen checkmark logic only for 'received' (user) messages
                  if (sender === 'received') {
                      if (seenByAdmin) {
                          wrapper.classList.add('seen');
                      }
                  }
            } else {
                 timeSpan.textContent = ''; // No timestamp for bot
            }


            wrapper.appendChild(p);
            wrapper.appendChild(timeSpan);
            messagesDiv.appendChild(wrapper);
            scrollToBottom();
        }

        function scrollToBottom() {
            clearTimeout(window.scrollTimeout);
            window.scrollTimeout = setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
        }


        // --- Admin Functionality (Adapted from previous admin.js) ---

        function loadUserListAndListeners() {
            // Clear existing list and cache before loading
            userListUL.innerHTML = '';
            cleanupAdminListeners(); // Ensure no old listeners remain
            currentUserList = {};

            const usersQuery = query(chatsRef, orderByChild('metadata/lastActive'));

            // Use onValue to get initial list and listen for sorting/metadata changes
            currentUserList.mainListener = onValue(usersQuery, (snapshot) => {
                const users = [];
                snapshot.forEach((childSnapshot) => {
                    const userId = childSnapshot.key;
                    const userData = childSnapshot.val();
                    if (userData?.metadata) {
                        users.push({
                            userId: userId,
                            userName: userData.metadata.userName || 'Unknown User',
                            lastActive: userData.metadata.lastActive || 0
                        });

                        // Initialize or update user cache
                        if (!currentUserList[userId]) {
                            currentUserList[userId] = {
                                userName: userData.metadata.userName || 'Unknown User',
                                unreadCount: 0,
                                listenersAttached: false // Flag to control listener attachment
                            };
                        } else {
                            currentUserList[userId].userName = userData.metadata.userName || 'Unknown User';
                        }

                        // Attach individual listeners if not already done
                         if (!currentUserList[userId].listenersAttached) {
                             attachUserSpecificListeners(userId);
                             currentUserList[userId].listenersAttached = true;
                         }
                    }
                });

                users.sort((a, b) => b.lastActive - a.lastActive);

                userListUL.innerHTML = ''; // Clear UI list
                users.forEach(user => {
                    displayUserInList(user.userId, user.userName);
                    updateUnreadIndicator(user.userId, currentUserList[user.userId]?.unreadCount || 0);
                });

                // Re-select if active
                if (selectedUserId && document.getElementById(`user-${selectedUserId}`)) {
                    document.getElementById(`user-${selectedUserId}`).classList.add('active');
                }
            }, (error) => console.error("Error loading user list:", error));

            // Attach global listeners (for calls etc.) only ONCE
             if (!globalListenersAttached) {
                 attachGlobalChangeListeners();
                 globalListenersAttached = true;
             }
        }

        function displayUserInList(userId, userName) {
            // (Same as previous admin.html version)
             const li = document.createElement('li');
             li.id = `user-${userId}`;
             li.dataset.userId = userId;
             const nameSpan = document.createElement('span');
             nameSpan.classList.add('user-name');
             nameSpan.textContent = userName;
             li.appendChild(nameSpan);
             const unreadIndicator = document.createElement('span');
             unreadIndicator.classList.add('unread-indicator');
             li.appendChild(unreadIndicator);
             li.onclick = () => selectUserChat(userId);
             userListUL.appendChild(li);
        }

         function attachUserSpecificListeners(userId) {
             if (!currentUserList[userId]) return;

             const userCache = currentUserList[userId];
             const userMessagesRef = ref(db, `chats/${userId}/messages`);
             const userStatusRef = ref(db, `chats/${userId}/status`);
             const userCallRef = ref(db, `chats/${userId}/call`);

             // --- Message Listener (Only for *new* messages using child_added) ---
             const messagesQuery = query(userMessagesRef, orderByChild('timestamp'), limitToLast(1)); // Listen only to the latest potential addition
             userCache.messageListener = onChildAdded(messagesQuery, (snapshot) => {
                  const messageId = snapshot.key;
                  const msg = snapshot.val();
                  // Check if message already processed (simple check based on element ID)
                  if (msg && !document.getElementById(`msg-${messageId}`)) {
                      if (userId === selectedUserId) {
                           displayMessage('received', msg.text, msg.timestamp, messageId, msg.seenByAdmin);
                           if (msg.sender === 'user' && !msg.seenByAdmin) {
                               markMessageAsSeen(userId, messageId);
                           }
                       } else if (msg.sender === 'user') {
                           userCache.unreadCount = (userCache.unreadCount || 0) + 1;
                           updateUnreadIndicator(userId, userCache.unreadCount);
                           if (!isMuted) {
                                showNotification(`New message from ${userCache.userName}`);
                           }
                       }
                  }
             }, (error) => console.error(`Error listening to messages for ${userId}:`, error));

             // --- Status Listener ---
             userCache.statusListener = onValue(userStatusRef, (snapshot) => {
                  if (userId === selectedUserId) updateUserStatusUI(snapshot.val());
             }, error => console.error(`Error listening to status for ${userId}:`, error));

             // --- Call Listener ---
             userCache.callListener = onValue(userCallRef, (snapshot) => {
                  // This listener handles calls for the *selected* user primarily
                  if (userId === selectedUserId) {
                      updateAdminCallUI(snapshot.val(), userId, userCache.userName);
                  }
             }, error => console.error(`Error listening to call status for ${userId}:`, error));
         }

         function attachGlobalChangeListeners() {
            // Listen for changes to *any* chat (like incoming calls for non-selected users)
            onChildChanged(chatsRef, (snapshot) => {
                 const userId = snapshot.key;
                 const changedData = snapshot.val();

                 // Global check for incoming calls
                 if (changedData?.call?.state === 'ringing' && changedData.call.initiator === 'user') {
                     if (userId !== selectedUserId) { // Only handle if not the selected user
                          const userName = changedData.metadata?.userName || changedData.call?.userName || 'Unknown User';
                          handleIncomingCall(userId, userName);
                     }
                 }
                 // Note: Metadata changes (like username) are handled by the main `onValue` listener in loadUserListAndListeners
            });
         }

         function cleanupAdminListeners() {
             // Detach the main user list listener
             if (currentUserList.mainListener) {
                 off(query(chatsRef, orderByChild('metadata/lastActive')), 'value', currentUserList.mainListener);
                 currentUserList.mainListener = null;
             }
             // Detach all user-specific listeners
             Object.keys(currentUserList).forEach(userId => {
                 if (typeof userId === 'string' && currentUserList[userId]) { // Check key is userId and object exists
                      detachUserSpecificListeners(userId);
                 }
             });
              // Detach global listeners if they were attached
              off(chatsRef, 'child_changed'); // Detach specific global listener
              globalListenersAttached = false;
              currentUserList = {}; // Clear user list cache
         }

         function detachUserSpecificListeners(userId) {
              const userCache = currentUserList[userId];
              if (!userCache) return;
              if (userCache.messageListener) off(ref(db, `chats/${userId}/messages`), 'child_added', userCache.messageListener);
              if (userCache.statusListener) off(ref(db, `chats/${userId}/status`), 'value', userCache.statusListener);
              if (userCache.callListener) off(ref(db, `chats/${userId}/call`), 'value', userCache.callListener);
              userCache.messageListener = null;
              userCache.statusListener = null;
              userCache.callListener = null;
              userCache.listenersAttached = false; // Reset flag
         }


        function selectUserChat(userId) {
            if (!currentUserList[userId] || loginState !== 'LOGGED_IN') return;
            if (selectedUserId === userId) return;

            console.log("Selecting chat for admin:", userId);

            // Deactivate previous selection
            if (selectedUserId) {
                const previousLi = document.getElementById(`user-${selectedUserId}`);
                if (previousLi) previousLi.classList.remove('active');
                // Note: We keep individual user listeners attached, just update UI based on selection
            }

            selectedUserId = userId;
            const currentLi = document.getElementById(`user-${selectedUserId}`);
            if (currentLi) currentLi.classList.add('active');

            currentUserList[userId].unreadCount = 0;
            updateUnreadIndicator(userId, 0);

            loadChatForSelectedUser(userId);

            messageInput.disabled = false;
            sendButton.disabled = false;
            blockUserButton.disabled = false;
            deleteChatButton.disabled = false;
            exportChatButton.disabled = false;
            messageInput.focus();
        }

        function loadChatForSelectedUser(userId) {
            messagesDiv.innerHTML = '';
            typingIndicatorDiv.textContent = '';
            hideAllCallNotifications(); // Clear existing notifications

            const userData = currentUserList[userId];
            currentChatUserNameH2.textContent = userData?.userName || 'Loading...';
            updateBlockButtonUI(userId);

            // Trigger immediate UI update for status and call state using existing listeners
             onValue(ref(db, `chats/${userId}/status`), (snap) => updateUserStatusUI(snap.val()), { onlyOnce: true });
             onValue(ref(db, `chats/${userId}/call`), (snap) => updateAdminCallUI(snap.val(), userId, userData?.userName), { onlyOnce: true });

            // Load initial batch of messages and mark as seen
            const messagesQuery = query(ref(db, `chats/${userId}/messages`), orderByChild('timestamp'), limitToLast(50));
            onValue(messagesQuery, (snapshot) => {
                messagesDiv.innerHTML = ''; // Clear before adding
                if (!snapshot.exists()) {
                    messagesDiv.innerHTML = '<p style="text-align:center; color:#ccc; margin-top: 20px;">No messages yet.</p>';
                    return;
                }
                let messagesToMarkSeen = [];
                snapshot.forEach((childSnapshot) => {
                    const msg = childSnapshot.val();
                    const msgId = childSnapshot.key;
                    displayMessage('received', msg.text, msg.timestamp, msgId, msg.seenByAdmin); // Display as received from user
                    if (msg.sender === 'user' && !msg.seenByAdmin) {
                        messagesToMarkSeen.push(msgId);
                    }
                });
                 scrollToBottom();
                 if (messagesToMarkSeen.length > 0) {
                     markMultipleMessagesAsSeen(userId, messagesToMarkSeen);
                 }
            }, { onlyOnce: true });
        }

        function clearChatView() {
            // Reset the chat area when no user is selected or during logout
            selectedUserId = null;
            messagesDiv.innerHTML = '';
            currentChatUserNameH2.textContent = loginState === 'LOGGED_IN' ? "Select a User" : "Admin Login";
            typingIndicatorDiv.textContent = '';
            hideAllCallNotifications();
            messageInput.value = '';
            messageInput.disabled = (loginState !== 'LOGGED_IN');
            sendButton.disabled = (loginState !== 'LOGGED_IN');
            blockUserButton.disabled = true;
            deleteChatButton.disabled = true;
            exportChatButton.disabled = true;
            userStatusDiv.classList.add('hidden'); // Hide user status dot area

             // Deactivate any active user in the list
             const activeLi = userListUL.querySelector('.active');
             if (activeLi) activeLi.classList.remove('active');
        }

        function updateUserStatusUI(status) {
            if (!selectedUserId || loginState !== 'LOGGED_IN') {
                 userStatusDiv.classList.add('hidden');
                 typingIndicatorDiv.textContent = '';
                 return;
            };

            userStatusDiv.classList.remove('hidden'); // Show the status area
            const userData = currentUserList[selectedUserId];
             if (status) {
                 const isOnline = status.userOnline || false;
                 userStatusSpan.classList.toggle('online', isOnline);
                 userStatusSpan.classList.toggle('offline', !isOnline);
                 userStatusSpan.parentElement.childNodes[0].nodeValue = isOnline ? 'User: Online ' : 'User: Offline ';
                 userStatusSpan.title = isOnline ? 'Online' : 'Offline';
                 typingIndicatorDiv.textContent = status.userTyping ? `${userData?.userName || 'User'} is typing...` : '';
             } else {
                 userStatusSpan.classList.remove('online');
                 userStatusSpan.classList.add('offline');
                 userStatusSpan.parentElement.childNodes[0].nodeValue = 'User: Offline ';
                 userStatusSpan.title = 'Offline';
                 typingIndicatorDiv.textContent = '';
             }
         }

         // --- Admin Sending Message ---
         function handleAdminSend() {
             if (loginState !== 'LOGGED_IN') {
                 handleLoginInput(); // Use the input for login flow
                 return;
             }
             if (!selectedUserId) {
                  alert("Please select a user chat first.");
                  return;
             }
             // Proceed to send message to the selected user
             const msgText = messageInput.value.trim();
             if (msgText) {
                 messageInput.value = '';
                 messageInput.focus();

                 const messageData = {
                     sender: 'admin',
                     text: msgText,
                     timestamp: serverTimestamp(),
                     seenByAdmin: true
                 };
                 const userMessagesRef = ref(db, `chats/${selectedUserId}/messages`);
                 push(userMessagesRef, messageData)
                     .then(() => {
                         displayMessage('sent', msgText, messageData.timestamp, null, true); // Display admin's own message
                         set(ref(db, `chats/${selectedUserId}/status/adminTyping`), false);
                         clearTimeout(typingTimeout);
                         update(ref(db, `chats/${selectedUserId}/metadata`), { lastActive: serverTimestamp() });
                     })
                     .catch(error => {
                         console.error("Error sending admin message: ", error);
                         messageInput.value = msgText; // Restore text
                         alert("Failed to send message.");
                     });
             }
         }

         // --- Typing Indicator (Admin) ---
         function handleAdminTyping() {
             if (loginState !== 'LOGGED_IN' || !selectedUserId) return;
             const adminTypingRef = ref(db, `chats/${selectedUserId}/status/adminTyping`);
             set(adminTypingRef, true);
             clearTimeout(typingTimeout);
             typingTimeout = setTimeout(() => {
                 set(adminTypingRef, false);
             }, 2000);
         }

         function handleInputKeyDown(e) {
             if (loginState !== 'LOGGED_IN') {
                  if (e.key === 'Enter') handleAdminSend(); // Trigger login flow on Enter
             } else {
                  if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      handleAdminSend(); // Trigger message send to user
                  } else {
                      handleAdminTyping(); // Trigger typing indicator update
                  }
             }
         }

         // --- Seen Status ---
          function markMessageAsSeen(userId, messageId) {
              if (userId !== selectedUserId || !messageId) return;
              const msgRef = ref(db, `chats/${userId}/messages/${messageId}`);
              update(msgRef, { seenByAdmin: true })
              .then(() => {
                  const msgElement = document.getElementById(`msg-${messageId}`);
                  if (msgElement && !msgElement.classList.contains('seen')) {
                      msgElement.classList.add('seen');
                  }
              })
              .catch(error => console.error(`Error marking message ${messageId} as seen:`, error));
         }
         function markMultipleMessagesAsSeen(userId, messageIds) {
              if (userId !== selectedUserId || messageIds.length === 0) return;
              const updates = {};
              messageIds.forEach(msgId => { updates[`chats/${userId}/messages/${msgId}/seenByAdmin`] = true; });
              update(ref(db), updates)
               .then(() => {
                   messageIds.forEach(msgId => {
                       const msgElement = document.getElementById(`msg-${msgId}`);
                       if (msgElement && !msgElement.classList.contains('seen')) {
                           msgElement.classList.add('seen');
                       }
                   });
               })
               .catch(error => console.error("Error bulk marking messages as seen:", error));
         }
         function updateUnreadIndicator(userId, count) {
             // (Same as previous admin.html version)
              const li = document.getElementById(`user-${userId}`);
              if (li) {
                  const indicator = li.querySelector('.unread-indicator');
                  if (indicator) {
                      if (count > 0) {
                           indicator.textContent = count > 9 ? '9+' : count;
                           indicator.classList.add('visible');
                      } else {
                           indicator.textContent = '';
                           indicator.classList.remove('visible');
                      }
                  }
              }
         }


         // --- Chat Actions (Block, Delete, Export) ---
         // (Use functions toggleBlockUser, updateBlockButtonUI, deleteChat, exportChat from previous admin.html, they should work as is)
         function toggleBlockUser() {
             if (!selectedUserId || loginState !== 'LOGGED_IN') return;
             const blockRef = ref(db, `chats/${selectedUserId}/metadata/isBlocked`);
             onValue(blockRef, (snapshot) => {
                 const isCurrentlyBlocked = snapshot.val() || false;
                 set(blockRef, !isCurrentlyBlocked)
                     .then(() => {
                         updateBlockButtonUI(selectedUserId);
                         alert(`User ${!isCurrentlyBlocked ? 'blocked' : 'unblocked'}.`);
                     })
                     .catch(error => console.error(`Error toggling block status for ${selectedUserId}:`, error));
             }, { onlyOnce: true });
         }
         function updateBlockButtonUI(userId) {
             if (!userId || userId !== selectedUserId || loginState !== 'LOGGED_IN') {
                 blockUserButton.textContent = 'Block';
                 blockUserButton.classList.remove('unblock');
                 blockUserButton.disabled = true; return;
             }
             blockUserButton.disabled = false;
             const blockRef = ref(db, `chats/${userId}/metadata/isBlocked`);
             onValue(blockRef, (snapshot) => {
                 const isBlocked = snapshot.val() || false;
                 blockUserButton.textContent = isBlocked ? 'Unblock' : 'Block';
                 blockUserButton.classList.toggle('unblock', isBlocked);
             }, { onlyOnce: true });
         }
         function deleteChat() {
             if (!selectedUserId || loginState !== 'LOGGED_IN') return;
             const userName = currentUserList[selectedUserId]?.userName || selectedUserId;
             if (confirm(`⚠️ DELETE CHAT with ${userName}? This cannot be undone.`)) {
                 remove(ref(db, `chats/${selectedUserId}/messages`))
                     .then(() => {
                         messagesDiv.innerHTML = '<p style="text-align:center; color:#ccc; margin-top:20px;">Chat history deleted.</p>';
                         alert('Chat history deleted.');
                     })
                     .catch(error => { console.error(`Error deleting chat:`, error); alert('Failed to delete chat.'); });
             }
         }
          function exportChat() {
              if (!selectedUserId || loginState !== 'LOGGED_IN') return;
              const userName = currentUserList[selectedUserId]?.userName || selectedUserId;
              const messagesQuery = query(ref(db, `chats/${selectedUserId}/messages`), orderByChild('timestamp'));
              onValue(messagesQuery, (snapshot) => {
                  if (!snapshot.exists()) { alert('No messages to export.'); return; }
                  let chatText = `Chat History with ${userName} (${selectedUserId})\nExported: ${new Date().toLocaleString()}\n\n`;
                  snapshot.forEach((cs) => {
                      const msg = cs.val();
                      const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : '[No Time]';
                      const sender = msg.sender === 'admin' ? 'Admin' : (userName || 'User');
                      chatText += `[${time}] ${sender}: ${msg.text}\n`;
                  });
                  const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' });
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  const safeUser = userName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                  link.download = `chat_${safeUser}_${selectedUserId.substring(0, 6)}.txt`;
                  link.click(); URL.revokeObjectURL(link.href);
              }, { onlyOnce: true });
          }

        // --- Audio Call Handling (Using Notification Area) ---
         function handleIncomingCall(userId, userName) {
              if (loginState !== 'LOGGED_IN') return; // Ignore calls if not logged in
              console.log(`Incoming call notification for ${userName} (${userId})`);
              // Avoid duplicate notifications for the same call
              if (document.getElementById(`call-alert-${userId}`)) return;

              const alertDiv = document.createElement('div');
              alertDiv.id = `call-alert-${userId}`;
              alertDiv.classList.add('call-alert', 'incoming');
              alertDiv.innerHTML = `
                  <span>Incoming call from <strong>${userName}</strong>!</span>
                  <button class="join">Join</button>
                  <button class="reject">Reject</button>
              `;
              callNotificationsContainer.appendChild(alertDiv);

              alertDiv.querySelector('.join').onclick = () => joinIncomingCall(userId, alertDiv);
              alertDiv.querySelector('.reject').onclick = () => rejectIncomingCall(userId, alertDiv);

              if (!isMuted) {
                  ringtoneAudio.play().catch(e => console.warn("Ringtone play failed:", e));
                  showNotification(`Incoming call from ${userName}!`);
              } else {
                  showNotification(`Incoming call from ${userName} (Sound Muted)`);
              }
         }

         function joinIncomingCall(userId, alertElement) {
              console.log(`Admin joining call with ${userId}`);
              ringtoneAudio.pause(); ringtoneAudio.currentTime = 0;
              if (alertElement) alertElement.remove(); // Remove incoming alert

              update(ref(db, `chats/${userId}/call`), {
                  state: 'active', joinedBy: 'admin', joinTimestamp: serverTimestamp()
              }).catch(error => console.error(`Error joining call:`, error));

              // Switch chat view if necessary
              if (userId !== selectedUserId) selectUserChat(userId);
              // The listener will update the UI to show the active call bar
               showActiveCallUI(userId, currentUserList[userId]?.userName || 'User');
         }

         function rejectIncomingCall(userId, alertElement) {
              console.log(`Admin rejecting call from ${userId}`);
              ringtoneAudio.pause(); ringtoneAudio.currentTime = 0;
              if (alertElement) alertElement.remove(); // Remove incoming alert

              update(ref(db, `chats/${userId}/call`), {
                  state: 'ended', endedBy: 'admin', endTimestamp: serverTimestamp()
              }).catch(error => console.error(`Error rejecting call:`, error));
         }

         function adminEndCall(userId) {
              console.log(`Admin ending call with ${userId}`);
              update(ref(db, `chats/${userId}/call`), {
                  state: 'ended', endedBy: 'admin', endTimestamp: serverTimestamp()
              }).catch(error => console.error(`Error ending call:`, error));
              // Listener update will hide the active call UI
              hideActiveCallUI(userId);
         }

          // Updates call UI based on listener data for the *selected* user or shows global alerts
          function updateAdminCallUI(callState, userId, userName) {
              if (loginState !== 'LOGGED_IN') return; // Only process if logged in

              const existingIncomingAlert = document.getElementById(`call-alert-${userId}`);
              const existingActiveAlert = document.getElementById(`call-active-${userId}`);

               // Handle incoming calls
               if (callState?.state === 'ringing' && callState.initiator === 'user') {
                    if (!existingIncomingAlert && !existingActiveAlert) { // Show only if no alert exists for this user
                         handleIncomingCall(userId, userName);
                    }
               } else if (existingIncomingAlert) {
                    // If state is no longer ringing, remove the incoming alert
                    existingIncomingAlert.remove();
                    ringtoneAudio.pause(); ringtoneAudio.currentTime = 0;
               }

                // Handle active calls
                if (callState?.state === 'active') {
                     if (!existingActiveAlert) { // Show only if not already shown
                         showActiveCallUI(userId, userName);
                     }
                 } else if (existingActiveAlert) {
                      // If state is no longer active, remove the active call UI
                      existingActiveAlert.remove();
                 }
          }


          function showActiveCallUI(userId, userName) {
                // Avoid duplicates
                if (document.getElementById(`call-active-${userId}`)) return;

                const activeDiv = document.createElement('div');
                activeDiv.id = `call-active-${userId}`;
                activeDiv.classList.add('call-alert', 'active');
                activeDiv.innerHTML = `
                    <span>Call active with <strong>${userName}</strong></span>
                    <button class="end">End Call</button>
                `;
                callNotificationsContainer.appendChild(activeDiv);
                activeDiv.querySelector('.end').onclick = () => adminEndCall(userId);
          }

          function hideActiveCallUI(userId) {
               const activeDiv = document.getElementById(`call-active-${userId}`);
               if (activeDiv) activeDiv.remove();
          }

          function hideAllCallNotifications() {
               callNotificationsContainer.innerHTML = '';
               ringtoneAudio.pause(); ringtoneAudio.currentTime = 0;
          }


        // --- Mute / Notifications ---
        // (Use toggleMute, updateMuteButtonUI, requestNotificationPermission, showNotification from previous admin.html)
         function toggleMute() { /* Same as before */ isMuted = !isMuted; localStorage.setItem('adminMuted', isMuted); updateMuteButtonUI(); if (isMuted) { ringtoneAudio.pause(); ringtoneAudio.currentTime = 0; } }
         function updateMuteButtonUI() { /* Same as before */ muteButton.textContent = isMuted ? 'Unmute Alerts' : 'Mute Alerts'; muteButton.classList.toggle('muted', isMuted); }
         function requestNotificationPermission() { /* Same as before */ if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') { Notification.requestPermission().then(p => console.log(`Notify permission: ${p}`)); } }
         function showNotification(message) { /* Same as before */ requestNotificationPermission(); if ('Notification' in window && Notification.permission === 'granted' && document.hidden) { new Notification('Admin Alert', { body: message }); } }


        // --- Initial Setup Calls ---
        sendButton.onclick = handleAdminSend; // Unified send button handler
        messageInput.onkeydown = handleInputKeyDown; // Unified keydown handler
        logoutButton.onclick = handleLogout;
        muteButton.onclick = toggleMute;
        updateMuteButtonUI(); // Set initial mute button text
        requestNotificationPermission(); // Ask for notification permission early
        startLoginBotConversation(); // Start the process

    </script>

</body>
</html>